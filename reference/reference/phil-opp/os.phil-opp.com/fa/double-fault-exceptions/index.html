<!doctype html>

<html lang="fa">

<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <meta name="description" content="ุงู ูพุณุช ุจู ุทูุฑ ุฏูู ุฌุฒุฆุงุช ุงุณุชุซูุง ุฎุทุง ุฏูฺฏุงูู (ุชุฑุฌูู: double fault exception) ุฑุง ุจุฑุฑุณ ูโฺฉูุฏุ ุงู ุงุณุชุซูุง ููฺฏุงู ุฑุฎ ูโุฏูุฏ ฺฉู CPU ูุชูุงูุฏ ฺฉ ฺฉูุชุฑู ฺฉููุฏูโฆ">
    <meta name="author" content="Philipp Oppermann">

    
        <link rel="canonical" href="index.html" />
    
    <link href="../../css/edition-2/main.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="RSS feed for os.phil-opp.com" href="../../rss.xml" />

    <script>
        let theme = localStorage.getItem("theme");
        if (theme != null) {
            document.documentElement.setAttribute("data-theme", theme);
        }
    </script>

    <script async src="../../js/edition-2/main.js"></script>

    <title>ุฎุทุงูุง ุฏูฺฏุงูู | Writing an OS in Rust</title>
</head>

<body>
    <div class="container content">
        <header class="masthead">
            <div style="position:relative">
                <h2 class="masthead-title">
                    <a href="../../index.html" title="Home">Writing an OS in Rust</a>
                </h2>
                <p><small>Philipp&nbsp;Oppermann's&nbsp;blog</small></p>
                
    <aside id="all-posts-link"><a href="https://os.phil-opp.com/fa" title="All Posts">ยซ ููู ูพุณุชโูุง</a></aside>

            </div>
        </header>

        <div class="theme-switch">
            <div class="light-switch" onclick="toggle_lights()" title="Switch between light and dark theme"></div>
            <div class="light-switch-reset" onclick="clear_theme_override()" title="Clear the theme override and go back to the system theme"></div>
        </div>

        <div>
            
<aside id="toc-aside" class="right-to-left">
        <h2>ููุฑุณุช ูุทุงูุจ</h2>
    <ol>
        <li>
            <a href="index.html#khty-dwgnh-chyst">ุฎุทุง ุฏูฺฏุงูู ฺุณุชุ</a>
            <ol>
                <li>
                    <a href="index.html#rhndzy-ykh-khty-dwgnh">ุฑุงูโุงูุฏุงุฒ ฺฉ ุฎุทุง ุฏูฺฏุงูู</a>
                </li>
            </ol>
        </li><li>
            <a href="index.html#khntrl-khnndh-khty-dwgnh">ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู</a>
            
        </li><li>
            <a href="index.html#ll-rkh-dd-khty-dwgnh">ุนูู ุฑุฎ ุฏุงุฏ ุฎุทุง ุฏูฺฏุงูู</a>
            <ol>
                <li>
                    <a href="index.html#srryzi-pshthy-hsth">ุณุฑุฑุฒู ูพุดุชูโ ูุณุชู</a>
                </li>
            </ol>
        </li><li>
            <a href="index.html#t-wyd-pshthh">ุชุนูุถ ูพุดุชูโูุง</a>
            <ol>
                <li>
                    <a href="index.html#ist-w-tss">IST ู TSS</a>
                </li><li>
                    <a href="index.html#yjd-ykh-tss">ุงุฌุงุฏ ฺฉ TSS</a>
                </li><li>
                    <a href="index.html#jdwl-twsyfgr-srsry">ุฌุฏูู ุชูุตูโฺฏุฑ ุณุฑุงุณุฑ</a>
                </li><li>
                    <a href="index.html#mrhl-pyny">ูุฑุงุญู ูพุงุงู</a>
                </li>
            </ol>
        </li><li>
            <a href="index.html#tst-srryz-pshth">ุชุณุช ุณุฑุฑุฒ ูพุดุชู</a>
            <ol>
                <li>
                    <a href="index.html#pydhszy-start">ูพุงุฏูโุณุงุฒ start_</a>
                </li><li>
                    <a href="index.html#tst-idt">ุชุณุช IDT</a>
                </li><li>
                    <a href="index.html#mdyr-khty-dwgnh">ูุฏุฑ ุฎุทุง ุฏูฺฏุงูู</a>
                </li>
            </ol>
        </li><li>
            <a href="index.html#khlsh">ุฎูุงุตู</a>
            
        </li><li>
            <a href="index.html#b-dy-chyst">ุจุนุฏ ฺุณุชุ</a>
            
        </li>
        <li class="toc-comments-link"><a href="index.html#comments">ูุธุฑุงุช</a></li>
    </ol>
</aside>

            <main>
    <div class="right-to-left">
    <h1>ุฎุทุงูุง ุฏูฺฏุงูู</h1>
    <time datetime="2018-06-18" class="post-date">
        Jun 18, 2018
        
    </time>
    </div>

    
        <div class="warning right-to-left">
            
            
            <p>
            <b>ูุญุชูุง ุชุฑุฌูู ุดุฏู:</b>
            ุงู ฺฉ ุชุฑุฌูู ุงุฒ ุฌุงูุนู ฺฉุงุฑุจุฑุงู ุจุฑุง ูพุณุช <strong><a href="../../double-fault-exceptions/index.html">Double Faults</a></strong> ุงุณุช. ููฺฉู ุงุณุช ูุงูุตุ ููุณูุฎ ุดุฏู ุง ุฏุงุฑุง ุฎุทุง ุจุงุดุฏ. ูุทูุง ูุฑ ฺฏููู ูุดฺฉู ุฑุง ุฏุฑ <a href="https://github.com/phil-opp/blog_os/issues/908">ุงู ุงุดู</a> ฺฏุฒุงุฑุด ุฏูุฏ!
            </p>
            <p>
                ุชุฑุฌูู ุชูุณุท <a href="https://github.com/hamidrezakp">@hamidrezakp</a> ู <a href="https://github.com/MHBahrampour">@MHBahrampour</a>.</p>
            </div>
    

    <div class="right-to-left">
    <p>ุงู ูพุณุช ุจู ุทูุฑ ุฏูู ุฌุฒุฆุงุช ุงุณุชุซูุง ุฎุทุง ุฏูฺฏุงูู (ุชุฑุฌูู: double fault exception) ุฑุง ุจุฑุฑุณ ูโฺฉูุฏุ ุงู ุงุณุชุซูุง ููฺฏุงู ุฑุฎ ูโุฏูุฏ ฺฉู CPU ูุชูุงูุฏ ฺฉ ฺฉูุชุฑู ฺฉููุฏู ุงุณุชุซูุง ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ. ุจุง ฺฉูุชุฑู ุงู ุงุณุชุซูุงุ ุงุฒ ุจุฑูุฒ <em>ุฎุทุงูุง ุณู ฺฏุงูู</em> (ุชุฑุฌูู: triple faults) ฺฉุดูุฏู ฺฉู ุจุงุนุซ ุฑุณุช (ฺฉููู: reset) ุดุฏู ุณุณุชู ูโุดููุฏุ ุฌููฺฏุฑ ูโฺฉูู. ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฎุทุงูุง ุณู ฺฏุงูู ุฏุฑ ููู ููุงุฑุฏุ ูุง ููฺูู ฺฉ <em>Interrupt Stack Table</em> ุฑุง ุชูุธู ฺฉุฑุฏูโุงู ุชุง ุฎุทุงูุง ุฏูฺฏุงูู ุฑุง ุฑู ฺฉ ูพุดุชู ูุณุชู ุฌุฏุงฺฏุงูู ุจฺฏุฑุฏ.</p>
<span id="continue-reading"></span>
<p>ุงู ุจูุงฺฏ ุจุตูุฑุช ุขุฒุงุฏ ุฑู <a href="https://github.com/phil-opp/blog_os">ฺฏุชโูุงุจ</a> ุชูุณุนู ุฏุงุฏู ุดุฏู ุงุณุช. ุงฺฏุฑ ุดูุง ูุดฺฉู ุง ุณูุงู ุฏุงุฑุฏุ ูุทูุงู ุขูโุฌุง ฺฉ ุงุดู ุจุงุฒ ฺฉูุฏ. ุดูุง ููฺูู ูโุชูุงูุฏ <a href="index.html#comments">ุฏุฑ ุฒุฑ</a> ุงู ูพุณุช ฺฉุงููุช ุจฺฏุฐุงุฑุฏ. ููุจุน ฺฉุฏ ฺฉุงูู ุงู ูพุณุช ุฑุง ูโุชูุงูุฏ ุฏุฑ ุจูุฑููฺ <a href="https://github.com/phil-opp/blog_os/tree/post-06"><code>post-06</code></a> ูพุฏุง ฺฉูุฏ.</p>
<!-- fix for zola anchor checker (target is in template): <a id="comments"> -->

    <details id = "toc-inline">
        <summary><b>ููุฑุณุช ูุทุงูุจ</b></summary>
        <ul>
            <li>
                <a href="index.html#khty-dwgnh-chyst">ุฎุทุง ุฏูฺฏุงูู ฺุณุชุ</a>
                <ul>
                    <li>
                        <a href="index.html#rhndzy-ykh-khty-dwgnh">ุฑุงูโุงูุฏุงุฒ ฺฉ ุฎุทุง ุฏูฺฏุงูู</a>
                    </li>
                </ul>
            </li><li>
                <a href="index.html#khntrl-khnndh-khty-dwgnh">ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู</a>
                
            </li><li>
                <a href="index.html#ll-rkh-dd-khty-dwgnh">ุนูู ุฑุฎ ุฏุงุฏ ุฎุทุง ุฏูฺฏุงูู</a>
                <ul>
                    <li>
                        <a href="index.html#srryzi-pshthy-hsth">ุณุฑุฑุฒู ูพุดุชูโ ูุณุชู</a>
                    </li>
                </ul>
            </li><li>
                <a href="index.html#t-wyd-pshthh">ุชุนูุถ ูพุดุชูโูุง</a>
                <ul>
                    <li>
                        <a href="index.html#ist-w-tss">IST ู TSS</a>
                    </li><li>
                        <a href="index.html#yjd-ykh-tss">ุงุฌุงุฏ ฺฉ TSS</a>
                    </li><li>
                        <a href="index.html#jdwl-twsyfgr-srsry">ุฌุฏูู ุชูุตูโฺฏุฑ ุณุฑุงุณุฑ</a>
                    </li><li>
                        <a href="index.html#mrhl-pyny">ูุฑุงุญู ูพุงุงู</a>
                    </li>
                </ul>
            </li><li>
                <a href="index.html#tst-srryz-pshth">ุชุณุช ุณุฑุฑุฒ ูพุดุชู</a>
                <ul>
                    <li>
                        <a href="index.html#pydhszy-start">ูพุงุฏูโุณุงุฒ start_</a>
                    </li><li>
                        <a href="index.html#tst-idt">ุชุณุช IDT</a>
                    </li><li>
                        <a href="index.html#mdyr-khty-dwgnh">ูุฏุฑ ุฎุทุง ุฏูฺฏุงูู</a>
                    </li>
                </ul>
            </li><li>
                <a href="index.html#khlsh">ุฎูุงุตู</a>
                
            </li><li>
                <a href="index.html#b-dy-chyst">ุจุนุฏ ฺุณุชุ</a>
                
            </li>
            <li class="toc-comments-link"><a href="index.html#comments">ูุธุฑุงุช</a></li>
        </ul>
    </details>

<h2 id="khty-dwgnh-chyst"><a class="zola-anchor" href="index.html#khty-dwgnh-chyst" aria-label="Anchor link for: khty-dwgnh-chyst">๐</a>ุฎุทุง ุฏูฺฏุงูู ฺุณุชุ</h2>
<p>ุจู ุนุจุงุฑุช ุณุงุฏูุ ุฎุทุง ุฏูฺฏุงูู ฺฉ ุงุณุชุซูุง ุจู ุฎุตูุต ุงุณุช ู ููฺฏุงู ุฑุฎ ูโุฏูุฏ ฺฉู CPU ูุชูุงูุฏ ฺฉ ฺฉูุชุฑู ฺฉููุฏู ุงุณุชุซูุง ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ. ุจู ุนููุงู ูุซุงูุ ุงู ุงุชูุงู ููฺฏุงู ุฑุฎ ูโุฏูุฏ ฺฉู ฺฉ page fault (ุชุฑุฌูู: ุฎุทุง ุตูุญู) ุฑุฎ ุฏูุฏ ุงูุง ูฺ ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏุฑ <a href="../../cpu-exceptions/index.html#the-interrupt-descriptor-table">ุฌุฏูู ุชูุตู ฺฉููุฏู ูููู</a> (ุชุฑุฌูู: Interrupt Descriptor Table) ุซุจุช ูุดุฏู ุจุงุดุฏ. ุจูุงุจุฑุงู ุจู ููุน ุดุจู ุจูุงฺฉโูุง ููู ฺฏุฑ ุฏุฑ ุฒุจุงูโูุง ุจุฑูุงููโููุณ ุจุง ุงุณุชุซูุงูุง ูโุจุงุดุฏุ ุจู ุนููุงู ูุซุงู <code>catch(...)</code> ุฏุฑ ++C ุง <code>catch(Exception e)</code> ุฏุฑ ุฌุงูุง ู #C.</p>
<p>ุฎุทุง ุฏูฺฏุงูู ูุงููุฏ ฺฉ ุงุณุชุซูุง ุนุงุฏ ุฑูุชุงุฑ ูโฺฉูุฏ. ุฏุงุฑุง ุดูุงุฑู ูฺฉุชูุฑ (ฺฉููู: vector) <code>8</code> ุงุณุช ู ูุง ูโุชูุงูู ฺฉ ุชุงุจุน ุทุจุน ฺฉูุชุฑู ฺฉููุฏู ุจุฑุง ุขู ุฏุฑ IDT ุชุนุฑู ฺฉูู. ุชูู ฺฉ ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู ุจุณุงุฑ ููู ุงุณุชุ ุฒุฑุง ุงฺฏุฑ ฺฉ ุฎุทุง ุฏูฺฏุงูู ฺฉูุชุฑู ูุดูุฏุ ฺฉ ุฎุทุง ฺฉุดูุฏู ุณู ฺฏุงูู ุฑุฎ ูโุฏูุฏ. ุฎุทุงูุง ุณู ฺฏุงูู ูุงุจู ฺฉุดู ูุณุชูุฏ ู ุงฺฉุซุฑ ุณุฎุช ุงูุฒุงุฑูุง ุจุง ุชูุธู ูุฌุฏุฏ ุณุณุชู ูุงฺฉูุด ูุดุงู ูโุฏููุฏ.</p>
<h3 id="rhndzy-ykh-khty-dwgnh"><a class="zola-anchor" href="index.html#rhndzy-ykh-khty-dwgnh" aria-label="Anchor link for: rhndzy-ykh-khty-dwgnh">๐</a>ุฑุงูโุงูุฏุงุฒ ฺฉ ุฎุทุง ุฏูฺฏุงูู</h3>
<p>ุจุงุฏ ฺฉ ุฎุทุง ุฏูฺฏุงูู ุฑุง ุจุง ุฑุงูโุงูุฏุงุฒ (ุชุฑุฌูู: triggering) ฺฉ ุงุณุชุซูุง ุจุฑุง ุขู ุงุฌุงุฏ ฺฉููุ ูุง ูููุฒ ฺฉ ุชุงุจุน ฺฉูุชุฑู ฺฉููุฏู ุชุนุฑู ูฺฉุฑุฏูโุงู:</p>
<pre data-lang="rust" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#608b4e;">// in src/main.rs
</span><span>
</span><span>#[no_mangle]
</span><span style="color:#569cd6;">pub extern </span><span style="color:#d69d85;">&quot;C&quot; </span><span style="color:#569cd6;">fn </span><span>_start() -&gt; </span><span style="color:#569cd6;">! </span><span>{
</span><span>    println!(</span><span style="color:#d69d85;">&quot;Hello World</span><span style="color:#b4cea8;">{}</span><span style="color:#d69d85;">&quot;</span><span>, </span><span style="color:#d69d85;">&quot;!&quot;</span><span>);
</span><span>
</span><span>    blog_os::init();
</span><span>
</span><span>    </span><span style="color:#608b4e;">// trigger a page fault
</span><span>    </span><span style="color:#569cd6;">unsafe </span><span>{
</span><span>        *(</span><span style="color:#b5cea8;">0xdeadbeef </span><span style="color:#569cd6;">as *mut u64</span><span>) = </span><span style="color:#b5cea8;">42</span><span>;
</span><span>    };
</span><span>
</span><span>    </span><span style="color:#608b4e;">// as before
</span><span>    #[cfg(test)]
</span><span>    test_main();
</span><span>
</span><span>    println!(</span><span style="color:#d69d85;">&quot;It did not crash!&quot;</span><span>);
</span><span>    </span><span style="color:#569cd6;">loop </span><span>{}
</span><span>}
</span></code></pre>
<p>ุจุฑุง ููุดุชู ุฏุฑ ุขุฏุฑุณ ูุงูุนุชุจุฑ <code>0xdeadbeef</code> ุงุฒ<code> unsafe</code> ุงุณุชูุงุฏู ูโฺฉูู. ุขุฏุฑุณ ูุฌุงุฒ ุฏุฑ ุฌุฏุงูู ุตูุญู ุจู ุขุฏุฑุณ ูุฒฺฉ ููพ ููโุดูุฏุ ุจูุงุจุฑุงู ุฎุทุง ุตูุญู ุฑุฎ ูโุฏูุฏ. ูุง ฺฉ ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุตูุญู ุฏุฑ <a href="../../cpu-exceptions/index.html#the-interrupt-descriptor-table">IDT</a> ุฎูุฏ ุซุจุช ูฺฉุฑุฏูโุงูุ ุจูุงุจุฑุงู ฺฉ ุฎุทุง ุฏูฺฏุงูู ุฑุฎ ูโุฏูุฏ.</p>
<p>ุญุงู ููุช ูุณุชู ุฑุง ุงุฌุฑุง ูโฺฉููุ ูโุจูู ฺฉู ูุงุฑุฏ ฺฉ ุญููู ุจูุช ุจโูพุงุงู ูโุดูุฏ. ุฏูุงู ุญููู ุจูุช ุจู ุดุฑุญ ุฒุฑ ุงุณุช:</p>
<p>ฑ. ุณโูพโู ุณุน ุจู ููุดุชู ุฏุฑ <code>0xdeadbeef</code> ุฏุงุฑุฏุ ฺฉู ุจุงุนุซ ุฎุทุง ุตูุญู ูโุดูุฏ.
ฒ. ุณโูพโู ุจู ูุฑูุฏ ูุฑุจูุทู ุฏุฑ IDT ูฺฏุงู ูโฺฉูุฏ ู ูโุจูุฏ ฺฉู ูฺ ุชุงุจุน ฺฉูุชุฑู ฺฉููุฏูโุง ูุดุฎุต ูุดุฏู ุงุณุช. ุจูุงุจุฑุงูุ ููโุชูุงูุฏ ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุตูุญู ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ ู ฺฉ ุฎุทุง ุฏูฺฏุงูู ุฑุฎ ูโุฏูุฏ.
ณ. ุณโูพโู ูุฑูุฏ IDT ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏู ฺฏุงูู ุฑุง ุจุฑุฑุณ ูโฺฉูุฏุ ุงูุง ุงู ูุฑูุฏ ูู ุชุงุจุน ฺฉูุชุฑู ฺฉููุฏูโุง ุฑุง  ูุดุฎุต ููโฺฉูุฏ. ุจูุงุจุฑุงูุ ฺฉ ุฎุทุง <em>ุณูโฺฏุงูู</em> ุฑุฎ ูโุฏูุฏ.
ด. ุฎุทุง ุณู ฺฏุงูู ฺฉุดูุฏู ุงุณุช. QEMU ูุงููุฏ ุงฺฉุซุฑ ุณุฎุช ุงูุฒุงุฑูุง ูุงูุน ุจู ุขู ูุงฺฉูุด ูุดุงู ุฏุงุฏู ุฏุณุชูุฑ ุฑุณุช ุดุฏู ุณุณุชู ุฑุง ุตุงุฏุฑ ูโฺฉูุฏ.</p>
<p>ุจูุงุจุฑุงู ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงู ุฎุทุง ุณูโฺฏุงููุ ุจุงุฏ ฺฉ ุชุงุจุน ฺฉูุชุฑู ฺฉููุฏู ุจุฑุง ุฎุทุงูุง ุตูุญู ุง ฺฉ ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู ุงุฑุงุฆู ุฏูู. ูุง ูโุฎูุงูู ุฏุฑ ููู ููุงุฑุฏ ุงุฒ ุฎุทุงูุง ุณู ฺฏุงูู ุฌููฺฏุฑ ฺฉููุ ุจูุงุจุฑุงู ุจุงุฏ ุจุง ฺฉ ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู ุดุฑูุน ฺฉูู ฺฉู ุจุฑุง ููู ุงููุงุน ุงุณุชุซูุง ุจุฏูู ฺฉูุชุฑู ูุฑุงุฎูุงู ูโุดูุฏ.</p>
<h2 id="khntrl-khnndh-khty-dwgnh"><a class="zola-anchor" href="index.html#khntrl-khnndh-khty-dwgnh" aria-label="Anchor link for: khntrl-khnndh-khty-dwgnh">๐</a>ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู</h2>
<p>ุฎุทุง ุฏูฺฏุงูู ฺฉ ุงุณุชุซูุง ุนุงุฏ ุจุง ฺฉุฏ ุฎุทุง ุงุณุชุ ุจูุงุจุฑุงู ูโุชูุงูู ฺฉ ุชุงุจุน ฺฉูุชุฑู ฺฉููุฏู ูุดุงุจู ฺฉูุชุฑู ฺฉููุฏู ููุทู ุดฺฉุณุช (ุชุฑุฌูู: breakpoint) ุชุนู ฺฉูู:</p>
<pre data-lang="rust" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#608b4e;">// in src/interrupts.rs
</span><span>
</span><span>lazy_static! {
</span><span>    </span><span style="color:#569cd6;">static ref </span><span style="color:#b4cea8;">IDT</span><span>: InterruptDescriptorTable = {
</span><span>        </span><span style="color:#569cd6;">let mut</span><span> idt = InterruptDescriptorTable::new();
</span><span>        idt.breakpoint.set_handler_fn(breakpoint_handler);
</span><span>        idt.double_fault.set_handler_fn(double_fault_handler); </span><span style="color:#608b4e;">// new
</span><span>        idt
</span><span>    };
</span><span>}
</span><span>
</span><span style="color:#608b4e;">// new
</span><span style="color:#569cd6;">extern </span><span style="color:#d69d85;">&quot;x86-interrupt&quot; </span><span style="color:#569cd6;">fn </span><span>double_fault_handler(
</span><span>    stack_frame: InterruptStackFrame, _error_code: </span><span style="color:#569cd6;">u64</span><span>) -&gt; </span><span style="color:#569cd6;">!
</span><span>{
</span><span>    panic!(</span><span style="color:#d69d85;">&quot;EXCEPTION: DOUBLE FAULT</span><span style="color:#e3bbab;">\n</span><span style="color:#d69d85;">{:#?}&quot;</span><span>, stack_frame);
</span><span>}
</span></code></pre>
<p>ฺฉูุชุฑู ฺฉููุฏู ูุง ฺฉ ูพุงู ุฎุทุง ฺฉูุชุงู ฺุงูพ ูโฺฉูุฏ ู ูุงุจ ูพุดุชู ุงุณุชุซูุง ุฑุง ุชุฎูู ูโฺฉูุฏ. ฺฉุฏ ุฎุทุง ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู ููุดู ุตูุฑ ุงุณุชุ ุจูุงุจุฑุงู ุฏูู ุจุฑุง ฺุงูพ ุขู ูุฌูุฏ ูุฏุงุฑุฏ. ฺฉ ุชูุงูุช ุฏุฑ ฺฉูุชุฑู ฺฉููุฏู ููุทู ุดฺฉุณุช ุงู ุงุณุช ฺฉู ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู <a href="https://doc.rust-lang.org/stable/rust-by-example/fn/diverging.html"><em>diverging</em></a> (ุชุฑุฌูู: ูุงฺฏุฑุง) ุงุณุช. ฺูู ูุนูุงุฑ <code>x86_64</code> ุงูฺฉุงู ุจุงุฒฺฏุดุช ุงุฒ ฺฉ ุงุณุชุซูุง ุฎุทุง ุฏูฺฏุงูู ุฑุง ูุฏุงุฑุฏ.</p>
<p>ุญุงู ููุช ูุณุชู ุฑุง ุงุฌุฑุง ูโฺฉููุ ุจุงุฏ ุจุจูู ฺฉู ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู ูุฑุงุฎูุงู ูโุดูุฏ:</p>
<p><img src="qemu-catch-double-fault.png" alt="QEMU printing EXCEPTION: DOUBLE FAULT and the exception stack frame" /></p>
<p>ฺฉุงุฑ ฺฉุฑุฏ! ุขูโฺู ุงู ุจุงุฑ ุงุชูุงู ูโุงูุชุฏ ุจุตูุฑุช ุฒุฑ ุงุณุช:</p>
<p>ฑ. ุณโูพโู ุณุน ุจู ููุดุชู ุฏุฑ <code>0xdeadbeef</code> ุฏุงุฑุฏุ ฺฉู ุจุงุนุซ ุฎุทุง ุตูุญู ูโุดูุฏ.
ฒ. ูุงููุฏ ูุจูุ ุณโูพโู ุจู ูุฑูุฏ ูุฑุจูุทู ุฏุฑ IDT ูฺฏุงู ูโฺฉูุฏ ู ูโุจูุฏ ฺฉู ูฺ ุชุงุจุน ฺฉูุชุฑู ฺฉููุฏูโุง ูุดุฎุต ูุดุฏู ุงุณุช. ุจูุงุจุฑุงูุ ฺฉ ุฎุทุง ุฏูฺฏุงูู ุฑุฎ ูโุฏูุฏ.
ณ. ุณโูพโู ุจู ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู - ฺฉู ุงฺฉููู ูุฌูุฏ ุฏุงุฑุฏ - ูโุฑูุฏ.</p>
<p>ุฎุทุง ุณู ฺฏุงูู (ู ุญููู ุจูุช) ุฏฺฏุฑ ุฑุฎ ููโุฏูุฏุ ุฒุฑุง ุงฺฉููู CPU ูโุชูุงูุฏ ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ.</p>
<p>ุงู ฺฉุงููุงู ุณุงุฏู ุจูุฏ! ูพุณ ฺุฑุง ูุง ุจุฑุง ุงู ููุถูุน ุจู ฺฉ ูพุณุช ฺฉุงูู ูุงุฒ ุฏุงุฑูุ ุฎุจุ ูุง ุงฺฉููู ูุงุฏุฑ ุจู ุฑุฏุงุจ <em>ุงฺฉุซุฑ</em> ุฎุทุงูุง ุฏูฺฏุงูู ูุณุชูุ ุงูุง ููุงุฑุฏ ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุฑูฺฉุฑุฏ ูุนู ูุง ฺฉุงู ูุณุช.</p>
<h2 id="ll-rkh-dd-khty-dwgnh"><a class="zola-anchor" href="index.html#ll-rkh-dd-khty-dwgnh" aria-label="Anchor link for: ll-rkh-dd-khty-dwgnh">๐</a>ุนูู ุฑุฎ ุฏุงุฏ ุฎุทุง ุฏูฺฏุงูู</h2>
<p>ูุจู ุงุฒ ุจุฑุฑุณ ููุงุฑุฏ ุฎุงุตุ ุจุงุฏ ุนูู ุฏูู ุฎุทุงูุง ุฏูฺฏุงูู ุฑุง ุจุฏุงูู. ุฏุฑ ุจุงูุงุ ูุง ุงุฒ ฺฉ ุชุนุฑู ฺฉุงููุง ูุจูู ุงุณุชูุงุฏู ฺฉุฑุฏู:</p>
<blockquote>
<p>ุฎุทุง ุฏูฺฏุงูู ฺฉ ุงุณุชุซูุง ุจู ุฎุตูุต ุงุณุช ู ููฺฏุงู ุฑุฎ ูโุฏูุฏ ฺฉู CPU ูุชูุงูุฏ ฺฉ ฺฉูุชุฑู ฺฉููุฏู ุงุณุชุซูุง ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ.</p>
</blockquote>
<p>ุนุจุงุฑุช <em>โfails to invokeโ</em> ุฏููุง ฺู ูุนูุง ุฏุงุฑุฏุ ฺฉูุชุฑู ฺฉููุฏู ูุฌูุฏ ูุฏุงุฑุฏุ ฺฉูุชุฑู ฺฉููุฏู <a href="http://pages.cs.wisc.edu/~remzi/OSTEP/vm-beyondphys.pdf">ุฎุงุฑุฌ ุดุฏู</a> (ููุธูุฑ ุงู ุงุณุช ฺฉู ุขุง ุตูุญู ูุฑุจูุท ุจู ฺฉูุชุฑู ฺฉููุฏู ุงุฒ ุญุงูุธู ุฎุงุฑุฌ ุดุฏู)ุ ู ุงฺฏุฑ ฺฉูุชุฑู ฺฉููุฏู ุฎูุฏุด ุจุงุนุซ ุฑุฎ ุฏุงุฏู ฺฉ ุงุณุชุซูุงูุง ุดูุฏุ ฺู ุงุชูุงู ุฑุฎ ูโุฏูุฏุ</p>
<p>ุจู ุนููุงู ูุซุงูุ ฺู ุงุชูุงู ูโุงูุชุฏ ุงฺฏุฑ:</p>
<p>ฑ. ฺฉ ุงุณุชุซูุง ููุทู ุดฺฉุณุช ุฑุฎ ูโุฏูุฏุ ุขุง ุชุงุจุน ฺฉูุชุฑู ฺฉููุฏู ูุฑุจูุทู ุฎุงุฑุฌ ุดุฏู ุงุณุชุ
ฒ. ฺฉ ุฎุทุง ุตูุญู ุฑุฎ ูโุฏูุฏุ ุขุง ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุตูุญู ุฎุงุฑุฌ ุดุฏู ุงุณุชุ
ณ. ฺฉูุชุฑู ฺฉููุฏูโ ยซุชูุณู ุจุฑ ุตูุฑยป ุจุงุนุซ ุฑุฎ ุฏุงุฏู ฺฉ ุงุณุชุซูุง ููุทู ุดฺฉุณุช ูโุดูุฏุ ุขุง ฺฉูุชุฑู ฺฉููุฏู ููุทู ุดฺฉุณุช ุฎุงุฑุฌ ุดุฏู ุงุณุชุ
ด. ูุณุชู ูุง ูพุดุชู ุฎูุฏ ุฑุง ุณุฑุฑุฒ ูโฺฉูุฏ ู ุขุง <em>ุตูุญู ูุญุงูุธ</em> (ุชุฑุฌูู: guard page) ุถุฑุจู ูโุฎูุฑุฏุ</p>
<p>ุฎูุดุจุฎุชุงููุ ฺฉุชุงุจฺู ุฑุงูููุง AMD64 (<a href="https://www.amd.com/system/files/TechDocs/24593.pdf">PDF</a>) ฺฉ ุชุนุฑู ุฏูู ุฏุงุฑุฏ (ุฏุฑ ุจุฎุด 8.2.9). ูุทุงุจู ุขูุ โฺฉ ุงุณุชุซูุง ุฎุทุง ุฏูฺฏุงูู <em>ูโุชูุงูุฏ</em> ุฒูุงู ุงุชูุงู ุจูุชุฏ ฺฉู ฺฉ ุงุณุชุซูุง ุฏูู ููฺฏุงู ฺฉุงุฑ ุจุง ฺฉ ฺฉูุชุฑู ฺฉููุฏู ุงุณุชุซูุง ูุจู (ุงูู) ุฑุฎ ุฏูุฏโ. <em>โู ุชูุงูุฏโ</em> ููู ุงุณุช: ููุท ุชุฑฺฉุจ ุจุณุงุฑ ุฎุงุต ุงุฒ ุงุณุชุซูุงูุง ููุฌุฑ ุจู ุฎุทุง ุฏูฺฏุงูู ูโุดูุฏ. ุงู ุชุฑฺฉุจุงุช ุนุจุงุฑุชูุฏ ุงุฒ:</p>
<table><thead><tr><th>ุงุณุชุซูุง ุงูู</th><th>ุงุณุชุซูุง ุฏูู</th></tr></thead><tbody>
<tr><td><a href="https://wiki.osdev.org/Exceptions#Divide-by-zero_Error">Divide-by-zero</a>,<br><a href="https://wiki.osdev.org/Exceptions#Invalid_TSS">Invalid TSS</a>,<br><a href="https://wiki.osdev.org/Exceptions#Segment_Not_Present">Segment Not Present</a>,<br><a href="https://wiki.osdev.org/Exceptions#Stack-Segment_Fault">Stack-Segment Fault</a>,<br><a href="https://wiki.osdev.org/Exceptions#General_Protection_Fault">General Protection Fault</a></td><td><a href="https://wiki.osdev.org/Exceptions#Invalid_TSS">Invalid TSS</a>,<br><a href="https://wiki.osdev.org/Exceptions#Segment_Not_Present">Segment Not Present</a>,<br><a href="https://wiki.osdev.org/Exceptions#Stack-Segment_Fault">Stack-Segment Fault</a>,<br><a href="https://wiki.osdev.org/Exceptions#General_Protection_Fault">General Protection Fault</a></td></tr>
<tr><td><a href="https://wiki.osdev.org/Exceptions#Page_Fault">Page Fault</a></td><td><a href="https://wiki.osdev.org/Exceptions#Page_Fault">Page Fault</a>,<br><a href="https://wiki.osdev.org/Exceptions#Invalid_TSS">Invalid TSS</a>,<br><a href="https://wiki.osdev.org/Exceptions#Segment_Not_Present">Segment Not Present</a>,<br><a href="https://wiki.osdev.org/Exceptions#Stack-Segment_Fault">Stack-Segment Fault</a>,<br><a href="https://wiki.osdev.org/Exceptions#General_Protection_Fault">General Protection Fault</a></td></tr>
</tbody></table>
<p>ุจูุงุจุฑุงู ุจู ุนููุงู ูุซุงูุ ฺฉ ุฎุทุง ุชูุณู ุจุฑ ุตูุฑ (ุชุฑุฌูู: Divide-by-zero) ู ุจู ุฏูุจุงู ุขู ุฎุทุง ุตูุญู (ุชุฑุฌูู: Page Fault)ุ ุฎูุจ ุงุณุช (ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุตูุญู ูุฑุงุฎูุงู ูโุดูุฏ)ุ ุงูุง ุฎุทุง ุชูุณู ุจุฑ ุตูุฑ ู ุจู ุฏูุจุงู ุขู ฺฉ ุฎุทุง ูุญุงูุธุช ุนููู (ุชุฑุฌูู: General Protection) ููุฌุฑ ุจู ุฎุทุง ุฏูฺฏุงูู ู ุดูุฏ.</p>
<p>ุจุง ฺฉูฺฉ ุงู ุฌุฏูู ูโุชูุงูู ุจู ุณู ููุฑุฏ ุงูู ุงุฒ ุณูุงูโูุง ุจุงูุง ูพุงุณุฎ ุฏูู:</p>
<p>ฑ. ุงฺฏุฑ ฺฉ ุงุณุชุซูุง ููุทู ุดฺฉุณุช ุงุชูุงู ุจูุชุฏ ู ุชุงุจุน ูุฑุจูุท ุจู ฺฉูุชุฑู ฺฉููุฏู ุขู ุฎุงุฑุฌ ุดุฏู ุจุงุดุฏุ ฺฉ <em>ุฎุทุง ุตูุญู</em> ุฑุฎ ูโุฏูุฏ ู <em>ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุตูุญู</em> ูุฑุงุฎูุงู ูโุดูุฏ.
ฒ. ุงฺฏุฑ ุฎุทุง ุตูุญู ุฑุฎ ุฏูุฏ ู ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุตูุญู ุฎุงุฑุฌ ุดุฏู ุจุงุดุฏุ ฺฉ <em>ุฎุทุง ุฏูฺฏุงูู</em> ุฑุฎ ูโุฏูุฏ ู <em>ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู</em> ูุฑุงุฎูุงู ูโุดูุฏ.
ณ. ุงฺฏุฑ ฺฉ ฺฉูุชุฑู ฺฉููุฏู ุชูุณู ุจุฑ ุตูุฑ ุจุงุนุซ ุงุณุชุซูุง ููุทู ุดฺฉุณุช ุดูุฏุ CPU ุณุน ูโฺฉูุฏ ุชุง ฺฉูุชุฑู ฺฉููุฏู ููุทู ุดฺฉุณุช ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ. ุงฺฏุฑ ฺฉูุชุฑู ฺฉููุฏู ููุทู ุดฺฉุณุช ุฎุงุฑุฌ ุดุฏู ุจุงุดุฏุ ฺฉ <em>ุฎุทุง ุตูุญู</em> ุฑุฎ ูโุฏูุฏ ู <em>ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุตูุญู</em> ูุฑุงุฎูุงู ูโุดูุฏ.</p>
<p>ุฏุฑ ุญููุชุ ุญุช ููุงุฑุฏ ุงุณุชุซูุง ุจุฏูู ุชุงุจุน ฺฉูุชุฑู ฺฉููุฏู ุฏุฑ IDT ูุฒ ุงุฒ ุงู ุทุฑุญ ูพุฑู ูโฺฉูุฏ: ููุช ุงุณุชุซูุง ุฑุฎ ูโุฏูุฏุ CPU ุณุน ูโฺฉูุฏ ูุฑูุฏ IDT ูุฑุจูุทู ุฑุง ุจุฎูุงูุฏ. ุงุฒ ุขูโุฌุง ฺฉู ูุฑูุฏ 0 ุงุณุชุ ฺฉู ฺฉ ูุฑูุฏ IDT ูุนุชุจุฑ ูุณุชุ ฺฉ <em>ุฎุทุง ูุญุงูุธุช ฺฉู</em> ุฑุฎ ูโุฏูุฏ. ูุง ฺฉ ุชุงุจุน ฺฉูุชุฑู ฺฉููุฏู ุจุฑุง ุฎุทุง ูุญุงูุธุช ุนููู ูุฒ ุชุนุฑู ูฺฉุฑุฏูุ ุจูุงุจุฑุงู ฺฉ ุฎุทุง ูุญุงูุธุช ุนููู ุฏฺฏุฑ ุฑุฎ ูโุฏูุฏ. ุทุจู ุฌุฏููุ ุงู ููุฌุฑ ุจู ฺฉ ุฎุทุง ุฏูฺฏุงูู ูโุดูุฏ.</p>
<h3 id="srryzi-pshthy-hsth"><a class="zola-anchor" href="index.html#srryzi-pshthy-hsth" aria-label="Anchor link for: srryzi-pshthy-hsth">๐</a>ุณุฑุฑุฒู ูพุดุชูโ ูุณุชู</h3>
<p>ุจุงุฏ ุจู ุณูุงู ฺูุงุฑู ูฺฏุงู ฺฉูู:</p>
<blockquote>
<p>ฺู ุงุชูุงู ูโุงูุชุฏ ุงฺฏุฑ ูุณุชู ูุง ูพุดุชู ุฎูุฏ ุฑุง ุณุฑุฑุฒ ฺฉูุฏ ู ุตูุญู ูุญุงูุธ ุถุฑุจู ุจุฎูุฑุฏุ</p>
</blockquote>
<p>ฺฉ ุตูุญู ูุญุงูุธ ฺฉ ุตูุญู ุญุงูุธู ูฺู ุฏุฑ ูพุงู ูพุดุชู ุงุณุช ฺฉู ุงูฺฉุงู ุชุดุฎุตู ุณุฑุฑุฒ ูพุดุชู ุฑุง ูุฑุงูู ูโฺฉูุฏ. ุตูุญู ุจู ูฺ ูุงุจ ูุฒฺฉ ููพ ูุดุฏู ุงุณุชุ ุจูุงุจุฑุงู ุฏุณุชุฑุณ ุจู ุขู ุจุงุนุซ ุฎุทุง ุตูุญู ูโุดูุฏ ุจู ุฌุง ุงูฺฉู ุจ ุตุฏุง ุญุงูุธู ุฏฺฏุฑ ุฑุง ุฎุฑุงุจ ฺฉูุฏ. ุจูุชโููุฏุฑ ฺฉ ุตูุญู ูุญุงูุธ ุจุฑุง ูพุดุชู ูุณุชู ูุง ุชูุธู ูโฺฉูุฏุ ุจูุงุจุฑุงู ุณุฑุฑุฒ ูพุดุชู ุจุงุนุซ <em>ุฎุทุง ุตูุญู</em> ูโุดูุฏ.</p>
<p>ููฺฏุงู ฺฉู ุฎุทุง ุตูุญู ุฑุฎ ูโุฏูุฏุ ูพุฑุฏุงุฒูุฏู ุจู ุฏูุจุงู ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุตูุญู ุฏุฑ IDT ุงุณุช ู ุณุน ูโฺฉูุฏ ุชุง <a href="../../cpu-exceptions/index.html#the-interrupt-stack-frame">ูุงุจ ูพุดุชู ูููู</a> ุฑุง ุจู ูพุดุชู ูพูุด ูโฺฉูุฏ. ุจุง ุงู ุญุงูุ ุงุดุงุฑูโฺฏุฑ ูพุดุชู ูุนู ูููุฒ ุจู ุตูุญู ูุญุงูุธ ุงุดุงุฑู ูโฺฉูุฏ ฺฉู ููุฌูุฏ ูุณุช. ุจูุงุจุฑุงูุ ุฎุทุง ุตูุญู ุฏูู ุฑุฎ ูโุฏูุฏุ ฺฉู ุจุงุนุซ ุฎุทุง ุฏูฺฏุงูู ูโุดูุฏ (ูุทุงุจู ุฌุฏูู ููู).</p>
<p>ุจูุงุจุฑุงู ุญุงูุง ูพุฑุฏุงุฒูุฏู ุณุน ูโฺฉูุฏ <em>ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู</em> ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ. ุจุง ุงู ุญุงูุ ููฺฏุงู ุฑุฎ ุฏุงุฏู ุฎุทุง ุฏูฺฏุงูู ูพุฑุฏุงุฒูุฏู ุณุน ูโฺฉูุฏ ุชุง ูุงุจ ูพุดุชู ุงุณุชุซูุง ุฑุง ูุฒ ูพูุด ฺฉูุฏ. ุงุดุงุฑูโฺฏุฑ ูพุดุชู ูููุฒ ุจู ุณูุช ุตูุญู ูุญุงูุธ ุงุณุชุ ุจูุงุจุฑุงู ฺฉ ุฎุทุง ุตูุญู <em>ุณูู</em> ุฑุฎ ูโูุฏ ฺฉู ุจุงุนุซ ฺฉ <em>ุฎุทุง ุณูโฺฏุงูู</em> ู ุฑุงู ุงูุฏุงุฒ ูุฌุฏุฏ ุณุณุชู ูโุดูุฏ. ุจูุงุจุฑุงู ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู ูุนู ูุง ููโุชูุงูุฏ ุงุฒ ุฎุทุง ุณูโฺฏุงูู ุฏุฑ ุงู ููุฑุฏ ุฌููฺฏุฑ ฺฉูุฏ.</p>
<p>ุจุงุฏ ุฎูุฏูุงู ุงูุชุญุงู ฺฉูู! ูุง ูโุชูุงูู ุจุง ูุฑุงุฎูุงู ุชุงุจุน ฺฉู ุจู ุทูุฑ ุจโูููู ุจุงุฒฺฏุดุช ูโุงุจุฏุ ุจู ุฑุงุญุช ุณุฑุฑุฒ ูพุดุชู ูุณุชู ุฑุง ุชุญุฑฺฉ ฺฉูู (ุจุงุนุซ ุฑุฎ ุฏุงุฏู ฺฉ ุณุฑุฑุฒ ูพุดุชู ูุณุชู ุดูู):</p>
<pre data-lang="rust" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#608b4e;">// in src/main.rs
</span><span>
</span><span>#[no_mangle] </span><span style="color:#608b4e;">// don&#39;t mangle the name of this function
</span><span style="color:#569cd6;">pub extern </span><span style="color:#d69d85;">&quot;C&quot; </span><span style="color:#569cd6;">fn </span><span>_start() -&gt; </span><span style="color:#569cd6;">! </span><span>{
</span><span>    println!(</span><span style="color:#d69d85;">&quot;Hello World</span><span style="color:#b4cea8;">{}</span><span style="color:#d69d85;">&quot;</span><span>, </span><span style="color:#d69d85;">&quot;!&quot;</span><span>);
</span><span>
</span><span>    blog_os::init();
</span><span>
</span><span>    </span><span style="color:#569cd6;">fn </span><span>stack_overflow() {
</span><span>        stack_overflow(); </span><span style="color:#608b4e;">// for each recursion, the return address is pushed
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#608b4e;">// trigger a stack overflow
</span><span>    stack_overflow();
</span><span>
</span><span>    [โฆ] </span><span style="color:#608b4e;">// test_main(), println(โฆ), and loop {}
</span><span>}
</span></code></pre>
<p>ููุช ุงู ฺฉุฏ ุฑุง ุฏุฑ QEMU ุงูุชุญุงู ูโฺฉููุ ูโุจูู ฺฉู ุณุณุชู ุฏูุจุงุฑู ูุงุฑุฏ ฺฉ ุญููู ุจูุช ูโุดูุฏ.</p>
<p>ุจูุงุจุฑุงู ฺฺฏููู ูโุชูุงูู ุงุฒ ุจุฑูุฒ ุงู ูุดฺฉู ุฌููฺฏุฑ ฺฉููุ ูุง ููโุชูุงูู ูพูุด ฺฉุฑุฏู ูุงุจ ูพุดุชู ุงุณุชุซูุง ุฑุง ุญุฐู ฺฉููุ ุฒุฑุง ูพุฑุฏุงุฒูุฏู ุฎูุฏ ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏ. ุจูุงุจุฑุงู ูุง ุจุงุฏ ุจู ูุญู ุงุทููุงู ุญุงุตู ฺฉูู ฺฉู ููุช ฺฉ ุงุณุชุซูุง ุฎุทุง ุฏูฺฏุงูู ุฑุฎ ูโุฏูุฏุ ูพุดุชู ููุดู ูุนุชุจุฑ ุงุณุช. ุฎูุดุจุฎุชุงููุ ูุนูุงุฑ x86_64 ุฑุงู ุญู ุจุฑุง ุงู ูุดฺฉู ุฏุงุฑุฏ.</p>
<h2 id="t-wyd-pshthh"><a class="zola-anchor" href="index.html#t-wyd-pshthh" aria-label="Anchor link for: t-wyd-pshthh">๐</a>ุชุนูุถ ูพุดุชูโูุง</h2>
<p>ูุนูุงุฑ x86_64 ูุงุฏุฑ ุงุณุช ุฏุฑ ุตูุฑุช ูููุน ฺฉ ุงุณุชุซูุง ุจู ฺฉ ูพุดุชู ุงุฒ ูพุด ุชุนุฑู ุดุฏู ู ุดูุงุฎุชู ุดุฏู ุชุนูุถ ุดูุฏ. ุงู ุชุนูุถ ุฏุฑ ุณุทุญ ุณุฎุช ุงูุฒุงุฑ ุงุชูุงู ูโุงูุชุฏุ ุจูุงุจุฑุงู ูโุชูุงู ุขู ุฑุง ูุจู ุงุฒ ุงูฺฉู ูพุฑุฏุงุฒูุฏู ูุงุจ ูพุดุชู ุงุณุชุซูุง ุฑุง ูพูุด ฺฉูุฏุ ุงูุฌุงู ุฏุงุฏ.</p>
<p>ูฺฉุงูุฒู ุชุนูุถ ุจู ุนููุงู <em>Interrupt Stack Table</em> (IST) ูพุงุฏูโุณุงุฒ ูโุดูุฏ. IST ุฌุฏูู ุงุณุช ุจุง 7 ุงุดุงุฑูโฺฏุฑ ุจุฑุง ุฏุณุชู ูุง ูุนุฑูู. ุฏุฑ ุดุจูโ ฺฉุฏ ุดุจู Rust:</p>
<pre data-lang="rust" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#569cd6;">struct </span><span>InterruptStackTable {
</span><span>    stack_pointers: [Option&lt;StackPointer&gt;; 7],
</span><span>}
</span></code></pre>
<p>ุจุฑุง ูุฑ ฺฉูุชุฑู ฺฉููุฏู ุงุณุชุซูุงุ ูโุชูุงูู ฺฉ ูพุดุชู ุงุฒ IST ุงุฒ ุทุฑู ููุฏ <code>stack_pointers</code> ูุฑุจูุท ุจู <a href="../../cpu-exceptions/index.html#the-interrupt-descriptor-table">IDT entry</a> ุงูุชุฎุงุจ ฺฉูู. ุจู ุนููุงู ูุซุงูุ ูุง ูโุชูุงูู ุงุฒ ุงููู ูพุดุชู ุฏุฑ IST ุจุฑุง ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู ุงุณุชูุงุฏู ฺฉูู. ูุฑฺฏุงู ุฎุทุง ุฏูฺฏุงูู ุฑุฎ ุฏูุฏุ ูพุฑุฏุงุฒูุฏู ุจู ุทูุฑ ุฎูุฏฺฉุงุฑ ุจู ุงู ูพุดุชู ุชุบุฑ ูโฺฉูุฏ. ุงู ุชุนูุถ ูุจู ุงุฒ ูพูุด ฺฉุฑุฏู ูุฑ ฺุฒ ุงุชูุงู ูโุงูุชุฏุ ุจูุงุจุฑุงู ุงุฒ ุฎุทุง ุณูโฺฏุงูู ุฌููฺฏุฑ ูโฺฉูุฏ.</p>
<h3 id="ist-w-tss"><a class="zola-anchor" href="index.html#ist-w-tss" aria-label="Anchor link for: ist-w-tss">๐</a>IST ู TSS</h3>
<p>ุฌุฏูู ูพุดุชู ูููู (ุชุฑุฌูู: Interrupt Stack Table: IST) ุจุฎุด ุงุฒ ฺฉ ุณุงุฎุชุงุฑ ูุฏู ุงุณุช ฺฉู ุจู ุขู <em><a href="https://en.wikipedia.org/wiki/Task_state_segment">ุณฺฏููุช ูุถุนุช ูพุฑูุณู</a></em> (Task State Segment: TSS) ฺฏูุชู ูโุดูุฏ. TSS ุจุฑุง ูฺฏูุฏุงุฑ ุงุทูุงุนุงุช ูุฎุชูู (ุจู ุนููุงู ูุซุงู ูุถุนุช ุซุจุงุช ูพุฑุฏุงุฒูุฏู) ุฏุฑ ููุฑุฏ ฺฉ ูพุฑูุณู ุฏุฑ ุญุงูุช 32 ุจุช ุงุณุชูุงุฏู ูโุดุฏ ู ุจู ุนููุงู ูุซุงู ุจุฑุง <a href="https://wiki.osdev.org/Context_Switching#Hardware_Context_Switching">ุชุนูุถ ุณุฎุชโุงูุฒุงุฑ context</a> (ุชุฑุฌูู: hardware context switching) ุงุณุชูุงุฏู ูโุดุฏ. ุจุง ุงู ุญุงูุ ุชุนูุถ ุณุฎุชโุงูุฒุงุฑ context ุฏฺฏุฑ ุฏุฑ ุญุงูุช 64 ุจุช ูพุดุชุจุงู ููโุดูุฏ ู ูุงูุจ TSS ฺฉุงููุงู ุชุบุฑ ฺฉุฑุฏู ุงุณุช.</p>
<p>ุฏุฑ x86_64ุ ุฏฺฏุฑ TSS ูฺ ุงุทูุงุนุงุช ุฎุงุต ุจุฑุง ูพุฑุณูโูุง ูุฏุงุฑุฏ. ุฏุฑ ุนูุถุ ุฏู ุฌุฏูู ูพุดุชู ุฑุง ุฏุฑ ุฎูุฏ ุฌุง ุฏุงุฏู ุงุณุช (IST ฺฉ ุงุฒ ุขููุงุณุช). ุชููุง ููุฏ ูุดุชุฑฺฉ ุจู TSS 32-bit ู TSS 64-bit ุงุดุงุฑูโฺฏุฑ ุจู <a href="https://en.wikipedia.org/wiki/Task_state_segment#I.2FO_port_permissions">ุจุชโููพ ูุฌูุฒูุง ูพูุฑุช I/O</a> ุงุณุช.</p>
<p>ูุฑูุช TSS 64-bit ูุงููุฏ ุฒุฑ ุงุณุช:</p>
<table><thead><tr><th>ููุฏ</th><th>ููุน</th></tr></thead><tbody>
<tr><td><span style="opacity: 0.5">(reserved)</span></td><td><code>u32</code></td></tr>
<tr><td>Privilege Stack Table</td><td><code>[u64; 3]</code></td></tr>
<tr><td><span style="opacity: 0.5">(reserved)</span></td><td><code>u64</code></td></tr>
<tr><td>Interrupt Stack Table</td><td><code>[u64; 7]</code></td></tr>
<tr><td><span style="opacity: 0.5">(reserved)</span></td><td><code>u64</code></td></tr>
<tr><td><span style="opacity: 0.5">(reserved)</span></td><td><code>u16</code></td></tr>
<tr><td>I/O Map Base Address</td><td><code>u16</code></td></tr>
</tbody></table>
<p>ููุช ุณุทุญ ููุชุงุฒ ุชุบุฑ ูโฺฉูุฏุ ูพุฑุฏุงุฒูุฏู ุงุฒ <em>Privilege Stack Table</em> ุงุณุชูุงุฏู ูโฺฉูุฏ. ุจู ุนููุงู ูุซุงูุ ุงฺฏุฑ ฺฉ ุงุณุชุซูุง ุฏุฑ ุญุงู ฺฉู CPU ุฏุฑ ุญุงูุช ฺฉุงุฑุจุฑ ุงุณุช (ุณุทุญ ููุชุงุฒ 3) ุฑุฎ ุฏูุฏุ CPU ูุนูููุงู ูุจู ุงุฒ ูุฑุงุฎูุงู ฺฉูุชุฑู ฺฉููุฏู ุงุณุชุซูุงุ ุจู ุญุงูุช ูุณุชู ุชุบุฑ ูโฺฉูุฏ (ุณุทุญ ุงูุชุงุฒ 0). ุฏุฑ ุงู ุญุงูุชุ CPU ุจู ูพุดุชู ุตูุฑู ุฏุฑ ุฌุฏูู ูพุดุชู ููุชุงุฒ ุชุบุฑ ูุถุนุช ู ุฏูุฏ (ุงุฒ ุขูุฌุง ฺฉู 0ุ ุณุทุญ ููุชุงุฒ ูุฏู ุงุณุช). ูุง ูููุฒ ูฺ ุจุฑูุงูู ุญุงูุช ฺฉุงุฑุจุฑ ูุฏุงุฑูุ ุจูุงุจุฑุงู ุงฺฉููู ุงู ุฌุฏูู ุฑุง ูุงุฏุฏู ูโฺฏุฑู.</p>
<h3 id="yjd-ykh-tss"><a class="zola-anchor" href="index.html#yjd-ykh-tss" aria-label="Anchor link for: yjd-ykh-tss">๐</a>ุงุฌุงุฏ ฺฉ TSS</h3>
<p>ุจุงุฏ ฺฉ TSS ุฌุฏุฏ ุงุฌุงุฏ ฺฉูู ฺฉู ุดุงูู ฺฉ ูพุดุชู ุฎุทุง ุฏูฺฏุงูู ุฌุฏุงฺฏุงูู ุฏุฑ ุฌุฏูู ูพุดุชู ูููู ุฎูุฏ ุจุงุดุฏ. ุจุฑุง ุงู ููุธูุฑ ูุง ุจู ฺฉ ุณุงุฎุชุงุฑ TSS ูุงุฒ ุฏุงุฑู. ุฎูุดุจุฎุชุงูู ฺฉุฑุช <code>x86_64</code> ุงุฒ ูุจู ุญุงู <a href="https://docs.rs/x86_64/0.14.2/x86_64/structures/tss/struct.TaskStateSegment.html">ุณุงุฎุชุงุฑ <code>TaskStateSegment</code></a> ุงุณุช ฺฉู ูโุชูุงูู ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉูู.</p>
<p>ูุง TSS ุฑุง ุฏุฑ ฺฉ ูุงฺูู ุฌุฏุฏ ุจู ูุงู <code>gdt</code> ุงุฌุงุฏ ูโฺฉูู (ูุงู ุงู ูุงฺูู ุจุนุฏุงู ุจุฑุงโุชุงู ูุนูุง ูพุฏุง ูโฺฉูุฏ):</p>
<pre data-lang="rust" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#608b4e;">// in src/lib.rs
</span><span>
</span><span style="color:#569cd6;">pub mod </span><span>gdt;
</span><span>
</span><span style="color:#608b4e;">// in src/gdt.rs
</span><span>
</span><span style="color:#569cd6;">use </span><span>x86_64::VirtAddr;
</span><span style="color:#569cd6;">use </span><span>x86_64::structures::tss::TaskStateSegment;
</span><span style="color:#569cd6;">use </span><span>lazy_static::lazy_static;
</span><span>
</span><span style="color:#569cd6;">pub const </span><span style="color:#b4cea8;">DOUBLE_FAULT_IST_INDEX</span><span>: </span><span style="color:#569cd6;">u16 </span><span>= </span><span style="color:#b5cea8;">0</span><span>;
</span><span>
</span><span>lazy_static! {
</span><span>    </span><span style="color:#569cd6;">static ref </span><span style="color:#b4cea8;">TSS</span><span>: TaskStateSegment = {
</span><span>        </span><span style="color:#569cd6;">let mut</span><span> tss = TaskStateSegment::new();
</span><span>        tss.interrupt_stack_table[</span><span style="color:#b4cea8;">DOUBLE_FAULT_IST_INDEX </span><span style="color:#569cd6;">as usize</span><span>] = {
</span><span>            </span><span style="color:#569cd6;">const </span><span style="color:#b4cea8;">STACK_SIZE</span><span>: </span><span style="color:#569cd6;">usize </span><span>= </span><span style="color:#b5cea8;">4096 </span><span>* </span><span style="color:#b5cea8;">5</span><span>;
</span><span>            </span><span style="color:#569cd6;">static mut </span><span style="color:#b4cea8;">STACK</span><span>: [</span><span style="color:#569cd6;">u8</span><span>; </span><span style="color:#b4cea8;">STACK_SIZE</span><span>] = [</span><span style="color:#b5cea8;">0</span><span>; </span><span style="color:#b4cea8;">STACK_SIZE</span><span>];
</span><span>
</span><span>            </span><span style="color:#569cd6;">let</span><span> stack_start = VirtAddr::from_ptr(</span><span style="color:#569cd6;">unsafe </span><span>{ </span><span style="color:#569cd6;">&amp;</span><span style="color:#b4cea8;">STACK </span><span>});
</span><span>            </span><span style="color:#569cd6;">let</span><span> stack_end = stack_start + </span><span style="color:#b4cea8;">STACK_SIZE</span><span>;
</span><span>            stack_end
</span><span>        };
</span><span>        tss
</span><span>    };
</span><span>}
</span></code></pre>
<p>ูุง ุงุฒ <code>lazy_static</code> ุงุณุชูุงุฏู ูโฺฉูู ุฒุฑุง ุงุฑุฒุงุจ ฺฉููุฏู ุซุงุจุช ุฑุงุณุช ูููุฒ ุขูโูุฏุฑ ุชูุงูููุฏ ูุณุช ฺฉู ุจุชูุงูุฏ ุงู ููุฏุงุฑุฏู ุงููู ุฑุง ุฏุฑ ุฒูุงู ฺฉุงููพุงู ุงูุฌุงู ุฏูุฏ. ูุง ุชุนุฑู ูโฺฉูู ฺฉู ูุฑูุฏ ุตูุฑู IST ูพุดุชู ุฎุทุง ุฏูฺฏุงูู ุงุณุช (ูุฑ ุงูุฏุณ ุฏฺฏุฑ ุงุฒ IST ูุฒ ูุงุจู ุงุณุชูุงุฏู ุงุณุช). ุณูพุณ ุขุฏุฑุณ ุจุงูุง ฺฉ ูพุดุชู ุฎุทุง ุฏูฺฏุงูู ุฑุง ุฏุฑ ูุฑูุฏ ุตูุฑู ูโููุณู. ูุง ุขุฏุฑุณ ุจุงูุง ุฑุง ูโููุณู ุฒุฑุง ูพุดุชูโูุง x86 ุจู ุณูุช ูพุงู ุฑุดุฏ ูโฺฉููุฏุ ุนู ุงุฒ ุขุฏุฑุณโูุง ุจุงูุง ุจู ุขุฏุฑุณโูุง ูพุงู ูโุขูุฏ.</p>
<p>ูุง ูููุฒ ูุฏุฑุช ุญุงูุธู ุฑุง ูพุงุฏู ุณุงุฒ ูฺฉุฑุฏูโุงูุ ุจูุงุจุฑุงู ุฑูุด ููุงุณุจ ุจุฑุง ุงุฎุชุตุงุต ูพุดุชู ุฌุฏุฏ ูุฏุงุฑู. ุฏุฑ ุนูุถุ ูุนูุงู ุงุฒ ฺฉ ุขุฑุงู <code>static mut</code> ุจู ุนููุงู ุญุงูุธู ูพุดุชู ุงุณุชูุงุฏู ูฺฉูู. <code>unsafe</code> ูุงุฒู ุงุณุช ุฒุฑุง ููฺฏุงู ุฏุณุชุฑุณ ุจู ุงุณุชุงุชฺฉโูุง ุชุบุฑูพุฐุฑ (ุชุฑุฌูู: mutable)ุ ฺฉุงููพุงูุฑ ููโุชูุงูุฏ ุนุฏู ูุฌูุฏ ุฑูุงุจุช ุจู ุฏุงุฏู ูุง ุฑุง ุชุถูู ฺฉูุฏ. ููู ุงุณุช ฺฉู ฺฉ <code>static mut</code> ุจุงุดุฏ ู ูู ฺฉ ุงุณุชุงุชฺฉโ ุชุบุฑูุงูพุฐุฑ (ุชุฑุฌูู: immutable)ุ ุฒุฑุง ุฏุฑ ุบุฑ ุงู ุตูุฑุช bootloader ุขู ุฑุง ุจู ฺฉ ุตูุญู ููุท ุฎูุงูุฏู ูฺฏุงุดุช ูโฺฉูุฏ. ูุง ุฏุฑ ูพุณุช ุจุนุฏ ุงู ุฑุง ุจุง ฺฉ ุชุฎุตุต ูพุดุชู ููุงุณุจ ุฌุงฺฏุฒู ุฎูุงูู ฺฉุฑุฏุ ุณูพุณ <code>unsafe</code> ุฏฺฏุฑ ุฏุฑ ุงูโุฌุง ููุฑุฏ ูุงุฒ ูุฎูุงูุฏ ุจูุฏ.</p>
<p>ุชูุฌู ุฏุงุดุชู ุจุงุดุฏ ฺฉู ุงู ูพุดุชู ุฎุทุง ุฏูฺฏุงูู ูุงูุฏ ุตูุญู ูุญุงูุธ ุฏุฑ ุจุฑุงุจุฑ ุณุฑุฑุฒ ูพุดุชู ุงุณุช. ุนู ูุง ูุจุงุฏ ูฺ ฺฉุงุฑ ฺฉู ุงุถุงูู ุดุฏู ุงุชู ุฏุฑ ูพุดุชู ุดูุฏ ุฑุง ุงูุฌุงู ุฏูู ุฒุฑุง ุณุฑุฑุฒ ูพุดุชู ููฺฉู ุงุณุช ุญุงูุธู ุฒุฑ ูพุดุชู ุฑุง ุฎุฑุงุจ ฺฉูุฏ.</p>
<h4 id="brgdhry-tss"><a class="zola-anchor" href="index.html#brgdhry-tss" aria-label="Anchor link for: brgdhry-tss">๐</a>ุจุงุฑฺฏุฐุงุฑ TSS</h4>
<p>ุงฺฉููู ฺฉู TSS ุฌุฏุฏ ุงุฌุงุฏ ฺฉุฑุฏูุ ุจู ุฑูุด ูุงุฒ ุฏุงุฑู ฺฉู ุจู CPU ุจฺฏูู ุจุงุฏ ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉูุฏ. ูุชุฃุณูุงูู ุงู ฺฉู ุฏุดูุงุฑ ุงุณุชุ ุฒุฑุง TSS ุจู ุฏูุงู ุชุงุฑุฎ ุงุฒ ุณุณุชู ุณฺฏููุชโุจูุฏ (ุชุฑุฌูู: segmentation) ุงุณุชูุงุฏู ูโฺฉูุฏ. ุจู ุฌุง ุจุงุฑฺฏุฐุงุฑ ูุณุชูู ุฌุฏููุ ุจุงุฏ ุชูุตูฺฏุฑ ุณฺฏููุช ุฌุฏุฏ ุฑุง ุจู <a href="https://web.archive.org/web/20190217233448/https://www.flingos.co.uk/docs/reference/Global-Descriptor-Table/">ุฌุฏูู ุชูุตูโฺฏุฑ ุณุฑุงุณุฑ</a> (Global Descriptor Table: GDT) ุงุถุงูู ฺฉูู. ุณูพุณ ูโุชูุงูู TSS ุฎูุฏ ุฑุง ุจุง ูุฑุงุฎูุงู <a href="https://www.felixcloutier.com/x86/ltr">ุฏุณุชูุฑ <code>ltr</code></a> ุจุง ุงูุฏุณ GDT ูุฑุจูุทู ุจุงุฑฺฏุฐุงุฑ ฺฉูู. (ุฏูู ุงูโฺฉู ูุงู ูุงฺูู ุฑุง <code>gdt</code> ฺฏุฐุงุดุชู ูุฒ ููู ุจูุฏ).</p>
<h3 id="jdwl-twsyfgr-srsry"><a class="zola-anchor" href="index.html#jdwl-twsyfgr-srsry" aria-label="Anchor link for: jdwl-twsyfgr-srsry">๐</a>ุฌุฏูู ุชูุตูโฺฏุฑ ุณุฑุงุณุฑ</h3>
<p>ุฌุฏูู ุชูุตูโฺฏุฑ ุณุฑุงุณุฑ (GDT) ฺฉ ุงุฏฺฏุงุฑ ุงุณุช ฺฉู ูุจู ุงุฒ ุงูโฺฉู ุตูุญูโุจูุฏ ุจู ุตูุฑุช ุงุณุชุงูุฏุงุฑุฏ ุชุจุฏู ุดูุฏุ ุจุฑุง <a href="https://en.wikipedia.org/wiki/X86_memory_segmentation">ุชูุณูโุจูุฏ ุญุงูุธู</a> ุงุณุชูุงุฏู ูโุดุฏ. ุงู ููุฑุฏ ููฺูุงู ุฏุฑ ุญุงูุช 64 ุจุช ุจุฑุง ููุงุฑุฏ ูุฎุชูู ูุงููุฏ ูพฺฉุฑุจูุฏ ูุณุชู/ฺฉุงุฑุจุฑ ุง ุจุงุฑฺฏุฐุงุฑ TSS ููุฑุฏ ูุงุฒ ุงุณุช.</p>
<p>ุฌุฏูู ุชูุตูโฺฏุฑ ุณุฑุงุณุฑุ ุณุงุฎุชุงุฑ ุงุณุช ฺฉู ุดุงูู <em>ุจุฎุดูุง</em> ุจุฑูุงูู ุงุณุช. ูุจู ุงุฒ ุงูฺฉู ุตูุญูโุจูุฏ ุจู ุงุณุชุงูุฏุงุฑุฏ ุชุจุฏู ุดูุฏุ ุงุฒ ุขู ุฏุฑ ูุนูุงุฑโูุง ูุฏู ุงุณุชูุงุฏู ูโุดุฏ ุชุง ุจุฑูุงูู ูุง ุฑุง ุงุฒ ฺฉุฏฺฏุฑ ุฌุฏุง ฺฉูุฏ. ุจุฑุง ฺฉุณุจ ุงุทูุงุนุงุช ุจุดุชุฑ ุฏุฑ ููุฑุฏ ุณฺฏููุชโุจูุฏุ ูุตู ูุฑุจูุท ุจู ุงู ููุถูุน ุฏุฑ <a href="http://pages.cs.wisc.edu/~remzi/OSTEP/">ฺฉุชุงุจ โThree Easy Piecesโ</a> ุฑุง ูุทุงูุนู ฺฉูุฏ. ุฏุฑ ุญุงู ฺฉู ุณฺฏููุชโุจูุฏ ุฏุฑ ุญุงูุช 64 ุจุช ุฏฺฏุฑ ูพุดุชุจุงู ููโุดูุฏุ GDT ูููุฒ ูุฌูุฏ ุฏุงุฑุฏ. ุจุดุชุฑ ุจุฑุง ุฏู ฺุฒ ุงุณุชูุงุฏู ูโุดูุฏ: ุฌุงุจุฌุง ุจู ูุถุง ูุณุชู ู ูุถุง ฺฉุงุฑุจุฑุ ู ุจุงุฑฺฏุฐุงุฑ ุณุงุฎุชุงุฑ TSS.</p>
<h4 id="yjd-ykh-gdt"><a class="zola-anchor" href="index.html#yjd-ykh-gdt" aria-label="Anchor link for: yjd-ykh-gdt">๐</a>ุงุฌุงุฏ ฺฉ GDT</h4>
<p>ุจุงุฏ ฺฉ <code>GDT</code> ุงุณุชุงุชฺฉ ุงุฌุงุฏ ฺฉูู ฺฉู ุดุงูู ฺฉ ุจุฎุด ุจุฑุง TSS ุงุณุชุงุชฺฉ ูุง ุจุงุดุฏ:</p>
<pre data-lang="rust" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#608b4e;">// in src/gdt.rs
</span><span>
</span><span style="color:#569cd6;">use </span><span>x86_64::structures::gdt::{GlobalDescriptorTable, Descriptor};
</span><span>
</span><span>lazy_static! {
</span><span>    </span><span style="color:#569cd6;">static ref </span><span style="color:#b4cea8;">GDT</span><span>: GlobalDescriptorTable = {
</span><span>        </span><span style="color:#569cd6;">let mut</span><span> gdt = GlobalDescriptorTable::new();
</span><span>        gdt.add_entry(Descriptor::kernel_code_segment());
</span><span>        gdt.add_entry(Descriptor::tss_segment(</span><span style="color:#569cd6;">&amp;</span><span style="color:#b4cea8;">TSS</span><span>));
</span><span>        gdt
</span><span>    };
</span><span>}
</span></code></pre>
<p>ูุง ุฏูุจุงุฑู ุงุฒ <code>lazy_static</code> ุงุณุชูุงุฏู ูโฺฉููุ ุฒุฑุง ุงุฑุฒุงุจ ฺฉููุฏู ุซุงุจุช ุฑุงุณุช ูููุฒ ุขูโูุฏุฑ ุชูุงูููุฏ ูุณุช. ูุง ฺฉ GDT ุฌุฏุฏ ุจุง ฺฉ ฺฉุฏ ุณฺฏููุช ู ฺฉ ุจุฎุด TSS ุงุฌุงุฏ ูโฺฉูู.</p>
<h4 id="brgdhry-gdt"><a class="zola-anchor" href="index.html#brgdhry-gdt" aria-label="Anchor link for: brgdhry-gdt">๐</a>ุจุงุฑฺฏุฐุงุฑ GDT</h4>
<p>ุจุฑุง ุจุงุฑฺฏุฐุงุฑ GDTุ ฺฉ ุชุงุจุน ุฌุฏุฏ <code>gdt::init</code> ุงุฌุงุฏ ูโฺฉูู ฺฉู ุขู ุฑุง ุงุฒ ุชุงุจุน <code>init</code> ูุฑุงุฎูุงู ูโฺฉูู:</p>
<pre data-lang="rust" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#608b4e;">// in src/gdt.rs
</span><span>
</span><span style="color:#569cd6;">pub fn </span><span>init() {
</span><span>    </span><span style="color:#b4cea8;">GDT</span><span>.load();
</span><span>}
</span><span>
</span><span style="color:#608b4e;">// in src/lib.rs
</span><span>
</span><span style="color:#569cd6;">pub fn </span><span>init() {
</span><span>    gdt::init();
</span><span>    interrupts::init_idt();
</span><span>}
</span></code></pre>
<p>ุงฺฉููู GDT ูุง ุจุงุฑฺฏุฐุงุฑ ุดุฏู ุงุณุช (ุงุฒ ุขูโุฌุง ฺฉู ุชุงุจุน <code>start_</code>ุ ุชุงุจุน <code>init</code> ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏ)ุ ุงูุง ูููุฒ ุญููู ุจูุช ุฑุง ููฺฏุงูู ุณุฑุฑุฒ ูพุดุชู ูุดุงูุฏู ูโฺฉูู.</p>
<h3 id="mrhl-pyny"><a class="zola-anchor" href="index.html#mrhl-pyny" aria-label="Anchor link for: mrhl-pyny">๐</a>ูุฑุงุญู ูพุงุงู</h3>
<p>ูุดฺฉู ุงู ุงุณุช ฺฉู ุณฺฏููุชโูุง GDT ูููุฒ ูุนุงู ูุณุชูุฏ ุฒุฑุง ุณฺฏููุช ู ุซุจุงุชโูุง TSS ูููุฒ ุญุงู ููุงุฏุฑ GDT ูุฏู ูุณุชูุฏ. ูุง ููฺูู ุจุงุฏ ูุฑูุฏ ุฎุทุง ุฏูฺฏุงูู IDT ุฑุง ุงุตูุงุญ ฺฉูู ุชุง ุงุฒ ูพุดุชู ุฌุฏุฏ ุงุณุชูุงุฏู ฺฉูุฏ.</p>
<p>ุจู ุทูุฑ ุฎูุงุตูุ ุจุงุฏ ููุงุฑุฏ ุฒุฑ ุฑุง ุงูุฌุงู ุฏูู:</p>
<p>ฑ. <strong>ุจุงุฑฺฏุฐุงุฑ ูุฌุฏุฏ ุซุจุงุช ฺฉุฏ ุณฺฏููุช</strong>: ูุง GDT ุฎูุฏ ุฑุง ุชุบุฑ ุฏุงุฏูุ ุจูุงุจุฑุงู ุจุงุฏ <code>cs</code>ุ ุซุจุงุช ฺฉุฏ ุณฺฏููุช ุฑุง ุจุงุฑฺฏุฐุงุฑ ูุฌุฏุฏ ฺฉูู. ุงู ููุฑุฏ ุงูุฒุงู ุงุณุช ุฒุฑุง ุงูุชุฎุงุจโฺฏุฑ ุณฺฏููุช ูุฏู ูโุชูุงูุฏ ุงฺฉููู ุชูุตูโฺฏุฑ ุฏฺฏุฑ ุงุฒ GDT ุฑุง ูุดุงู ุฏูุฏ (ุจู ุนููุงู ูุซุงู ุชูุตู ฺฉููุฏู TSS).
ฒ. <strong>ุจุงุฑฺฏุฐุงุฑ TSS</strong>: ูุง ฺฉ GDT ุจุงุฑฺฏุฐุงุฑ ฺฉุฑุฏู ฺฉู ุดุงูู ฺฉ ุงูุชุฎุงุจโฺฏุฑ TSS ุงุณุชุ ุงูุง ูููุฒ ุจุงุฏ ุจู CPU ุจฺฏูู ฺฉู ุจุงุฏ ุงุฒ ุขู TSS ุงุณุชูุงุฏู ฺฉูุฏ.
ณ. <strong>ุจุฑูุฒุฑุณุงู ูุฑูุฏ IDT</strong>: ุจู ูุญุถ ุงูโฺฉู TSS ุจุงุฑฺฏุฐุงุฑ ุดุฏุ CPU ุจู ฺฉ ุฌุฏูู ูพุดุชู ูููู ูุนุชุจุฑ (IST) ุฏุณุชุฑุณ ุฏุงุฑุฏ. ุณูพุณ ูโุชูุงูู ุจู CPU ุจฺฏูู ฺฉู ุจุงุฏ ุจุง ุชุบุฑ ุฏุฑ ูุฑูุฏ IDT ุฎุทุง ุฏูฺฏุงูู ุงุฒ ูพุดุชู ุฎุทุง ุฏูฺฏุงูู ุฌุฏุฏ ุงุณุชูุงุฏู ฺฉูุฏ.</p>
<p>ุจุฑุง ุฏู ูุฑุญูู ุงููุ ูุง ูุงุฒ ุจู ุฏุณุชุฑุณ ุจู ูุชุบุฑูุง<code> code_selector</code> ู <code>tss_selector</code> ุฏุฑ ุชุงุจุน <code>gdt::init</code> ุฏุงุฑู. ูโุชูุงูู ุจุง ุชุจุฏู ุขูโูุง ุจู ุจุฎุด ุงุฒ ุงุณุชุงุชฺฉ ุงุฒ ุทุฑู ุณุงุฎุชุงุฑ ุฌุฏุฏ <code>Selectors</code> ุจู ุงู ูุฏู ุจุฑุณู:</p>
<pre data-lang="rust" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#608b4e;">// in src/gdt.rs
</span><span>
</span><span style="color:#569cd6;">use </span><span>x86_64::structures::gdt::SegmentSelector;
</span><span>
</span><span>lazy_static! {
</span><span>    </span><span style="color:#569cd6;">static ref </span><span style="color:#b4cea8;">GDT</span><span>: (GlobalDescriptorTable, Selectors) = {
</span><span>        </span><span style="color:#569cd6;">let mut</span><span> gdt = GlobalDescriptorTable::new();
</span><span>        </span><span style="color:#569cd6;">let</span><span> code_selector = gdt.add_entry(Descriptor::kernel_code_segment());
</span><span>        </span><span style="color:#569cd6;">let</span><span> tss_selector = gdt.add_entry(Descriptor::tss_segment(</span><span style="color:#569cd6;">&amp;</span><span style="color:#b4cea8;">TSS</span><span>));
</span><span>        (gdt, Selectors { code_selector, tss_selector })
</span><span>    };
</span><span>}
</span><span>
</span><span style="color:#569cd6;">struct </span><span>Selectors {
</span><span>    code_selector: SegmentSelector,
</span><span>    tss_selector: SegmentSelector,
</span><span>}
</span></code></pre>
<p>ุงฺฉููู ูโุชูุงูู ุจุง ุงุณุชูุงุฏู ุงุฒ ุงูุชุฎุงุจโฺฏุฑูุงุ ุซุจุงุช ุจุฎุด <code>cs</code> ุฑุง ุจุงุฑฺฏุฐุงุฑ ูุฌุฏุฏ ฺฉุฑุฏู ู <code>TSS</code> ุฑุง ุจุงุฑฺฏุฐุงุฑ ฺฉูู:</p>
<pre data-lang="rust" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#608b4e;">// in src/gdt.rs
</span><span>
</span><span style="color:#569cd6;">pub fn </span><span>init() {
</span><span>    </span><span style="color:#569cd6;">use </span><span>x86_64::instructions::segmentation::set_cs;
</span><span>    </span><span style="color:#569cd6;">use </span><span>x86_64::instructions::tables::load_tss;
</span><span>
</span><span>    </span><span style="color:#b4cea8;">GDT</span><span>.</span><span style="color:#b5cea8;">0.</span><span>load();
</span><span>    </span><span style="color:#569cd6;">unsafe </span><span>{
</span><span>        set_cs(</span><span style="color:#b4cea8;">GDT</span><span>.</span><span style="color:#b5cea8;">1.</span><span>code_selector);
</span><span>        load_tss(</span><span style="color:#b4cea8;">GDT</span><span>.</span><span style="color:#b5cea8;">1.</span><span>tss_selector);
</span><span>    }
</span><span>}
</span></code></pre>
<p>ูุง ุจุง ุงุณุชูุงุฏู ุงุฒ <a href="https://docs.rs/x86_64/0.14.2/x86_64/instructions/segmentation/fn.set_cs.html"><code>set_cs</code></a> ุซุจุงุช ฺฉุฏ ุณฺฏููุช ุฑุง ุจุงุฑฺฏุฐุงุฑ ูุฌุฏุฏ ูโฺฉูู ู ุจุฑุง ุจุงุฑฺฏุฐุงุฑ TSS ุจุง ุงุฒ <a href="https://docs.rs/x86_64/0.14.2/x86_64/instructions/tables/fn.load_tss.html"><code>load_tss</code></a> ุงุณุชูุงุฏู ูโฺฉูู. ุชูุงุจุน ุจู ุนููุงู <code>unsafe</code> ุนูุงูุช ฺฏุฐุงุฑ ุดุฏูโุงูุฏุ ุจูุงุจุฑุงู ุจุฑุง ูุฑุงุฎูุงู ุขูโูุง ุจู ฺฉ ุจููฺฉ <code>unsafe</code> ูุงุฒ ุฏุงุฑู. ฺูู ููฺฉู ุงุณุช ุจุง ุจุงุฑฺฏุฐุงุฑ ุงูุชุฎุงุจโฺฏุฑูุง ูุงูุนุชุจุฑุ ุงูู ุญุงูุธู ุงุฒ ุจู ุจุฑูุฏ.</p>
<p>ุงฺฉููู ฺฉู ฺฉ TSS ูุนุชุจุฑ ู ุฌุฏูู ูพุดุชูโ ูููู ุฑุง ุจุงุฑฺฏุฐุงุฑ ฺฉุฑุฏูุ ูโุชูุงูู ุงูุฏุณ ูพุดุชู ุฑุง ุจุฑุง ฺฉูุชุฑู ฺฉููุฏู ุฎุทุง ุฏูฺฏุงูู ุฏุฑ IDT ุชูุธู ฺฉูู:</p>
<pre data-lang="rust" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#608b4e;">// in src/interrupts.rs
</span><span>
</span><span style="color:#569cd6;">use crate</span><span>::gdt;
</span><span>
</span><span>lazy_static! {
</span><span>    </span><span style="color:#569cd6;">static ref </span><span style="color:#b4cea8;">IDT</span><span>: InterruptDescriptorTable = {
</span><span>        </span><span style="color:#569cd6;">let mut</span><span> idt = InterruptDescriptorTable::new();
</span><span>        idt.breakpoint.set_handler_fn(breakpoint_handler);
</span><span>        </span><span style="color:#569cd6;">unsafe </span><span>{
</span><span>            idt.double_fault.set_handler_fn(double_fault_handler)
</span><span>                .set_stack_index(gdt::</span><span style="color:#b4cea8;">DOUBLE_FAULT_IST_INDEX</span><span>); </span><span style="color:#608b4e;">// new
</span><span>        }
</span><span>
</span><span>        idt
</span><span>    };
</span><span>}
</span></code></pre>
<p>ุฑูุด <code>set_stack_index</code> ุงูู ูุณุช ุฒุฑุง ูุฑุงุฎูุงู (ุชุฑุฌูู: caller) ุจุงุฏ ุงุทููุงู ุญุงุตู ฺฉูุฏ ฺฉู ุงูุฏุณ ุงุณุชูุงุฏู ุดุฏู ูุนุชุจุฑ ุงุณุช ู ูุจูุงู ุจุฑุง ุงุณุชุซูุง ุฏฺฏุฑ ุงุณุชูุงุฏู ูุดุฏู ุงุณุช.</p>
<p>ููู! ุงฺฉููู CPU ุจุงุฏ ูุฑ ุฒูุงู ฺฉู ุฎุทุง ุฏูฺฏุงูู ุฑุฎ ุฏุงุฏุ ุจู ูพุดุชู ุฎุทุง ุฏูฺฏุงูู ุจุฑูุฏ. ุจูุงุจุฑุงูุ ูุง ูโุชูุงูู <em>ููู</em> ุฎุทุงูุง ุฏูฺฏุงููุ ุงุฒ ุฌููู ุณุฑุฑุฒูุง ูพุดุชู ูุณุชู ุฑุง ุจฺฏุฑู:</p>
<p><img src="qemu-double-fault-on-stack-overflow.png" alt="QEMU printing EXCEPTION: DOUBLE FAULT and a dump of the exception stack frame" /></p>
<p>ุงุฒ ุงู ุจู ุจุนุฏ ูุฑฺฏุฒ ูุจุงุฏ ุดุงูุฏ ุฎุทุง ุณูโฺฏุงูู ุจุงุดู! ุจุฑุง ุงุทููุงู ุงุฒ ุงูฺฉู ููุงุฑุฏ ุจุงูุง ุฑุง ุจู ุทูุฑ ุชุตุงุฏู ููุถ ููโฺฉููุ ุจุงุฏ ฺฉ ุชุณุช ุจุฑุง ุงู ฺฉุงุฑ ุงุถุงูู ฺฉูู.</p>
<h2 id="tst-srryz-pshth"><a class="zola-anchor" href="index.html#tst-srryz-pshth" aria-label="Anchor link for: tst-srryz-pshth">๐</a>ุชุณุช ุณุฑุฑุฒ ูพุดุชู</h2>
<p>ุจุฑุง ุขุฒูุงุด ูุงฺูู <code>gdt</code> ุฌุฏุฏ ู ุงุทููุงู ุงุฒ ุงูฺฉู ูุฏุฑ ุฎุทุง ุฏูฺฏุงูู ุจู ุฏุฑุณุช ููฺฏุงู ุณุฑุฑุฒ ูพุดุชู ูุฑุงุฎูุงู ุดุฏู ุงุณุชุ ูโุชูุงูู ฺฉ ุชุณุช ฺฉูพุงุฑฺู ุงุถุงูู ฺฉูู. ุงุฏู ุงู ุงุณุช ฺฉู ฺฉ ุฎุทุง ุฏูฺฏุงูู ุฏุฑ ุชุงุจุน ุชุณุช ุงุฌุงุฏ ฺฉูุฏ ู ุชุฃุฏ ฺฉูุฏ ฺฉู ูุฏุฑ ุฎุทุง ุฏูฺฏุงูู ูุฑุงุฎูุงู ูโุดูุฏ.</p>
<p>ุจุงุฏ ุจุง ฺฉ ุทุฑุญ ูููุงู ุดุฑูุน ฺฉูู:</p>
<pre data-lang="rust" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#608b4e;">// in tests/stack_overflow.rs
</span><span>
</span><span>#![no_std]
</span><span>#![no_main]
</span><span>
</span><span style="color:#569cd6;">use </span><span>core::panic::PanicInfo;
</span><span>
</span><span>#[no_mangle]
</span><span style="color:#569cd6;">pub extern </span><span style="color:#d69d85;">&quot;C&quot; </span><span style="color:#569cd6;">fn </span><span>_start() -&gt; </span><span style="color:#569cd6;">! </span><span>{
</span><span>    unimplemented!();
</span><span>}
</span><span>
</span><span>#[panic_handler]
</span><span style="color:#569cd6;">fn </span><span>panic(info: </span><span style="color:#569cd6;">&amp;</span><span>PanicInfo) -&gt; </span><span style="color:#569cd6;">! </span><span>{
</span><span>    blog_os::test_panic_handler(info)
</span><span>}
</span></code></pre>
<p>ูุงููุฏ ุชุณุช <code>panic_handler</code>ุ ุชุณุช <a href="../../testing/index.html#no-harness-tests">ุจุฏูู ฺฉ test harness</a> ุงุฌุฑุง ุฎูุงูุฏ ุดุฏ. ุฒุฑุง ูพุณ ุงุฒ ฺฉ ุฎุทุง ุฏูฺฏุงูู ููโุชูุงูู ุงุฌุฑุง ุฑุง ุงุฏุงูู ุฏููุ ุจูุงุจุฑุงู ุจุด ุงุฒ ฺฉ ุชุณุช ููุทู ูุณุช. ุจุฑุง ุบุฑูุนุงู ฺฉุฑุฏู test harness ุจุฑุง ุงู ุชุณุชุ ููุงุฑุฏ ุฒุฑ ุฑุง ุจู <code>Cargo.toml</code> ุงุถุงูู ูโฺฉูู:</p>
<pre data-lang="toml" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-toml "><code class="language-toml" data-lang="toml"><span style="color:#608b4e;"># in Cargo.toml
</span><span>
</span><span>[[</span><span style="color:#808080;">test</span><span>]]
</span><span style="color:#569cd6;">name </span><span>= </span><span style="color:#d69d85;">&quot;stack_overflow&quot;
</span><span style="color:#569cd6;">harness </span><span>= </span><span style="color:#569cd6;">false
</span></code></pre>
<p>ุญุงู ุจุงุฏ <code>cargo test --test stack_overflow</code> ุจุตูุฑุช ููููุชโุขูุฒ ฺฉุงููพุงู ุดูุฏ. ุงูุจุชู ุงู ุชุณุช ุจุง ุดฺฉุณุช ููุงุฌู ูโุดูุฏุ ุฒุฑุง ูุงฺฉุฑู <code>unimplemented</code> ูพูฺฉ ูโฺฉูุฏ.</p>
<h3 id="pydhszy-start"><a class="zola-anchor" href="index.html#pydhszy-start" aria-label="Anchor link for: pydhszy-start">๐</a>ูพุงุฏูโุณุงุฒ <code>start_</code></h3>
<p>ูพุงุฏูโุณุงุฒ ุชุงุจุน <code>start_</code> ูุงููุฏ ุงู ุงุณุช:</p>
<pre data-lang="rust" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#608b4e;">// in tests/stack_overflow.rs
</span><span>
</span><span style="color:#569cd6;">use </span><span>blog_os::serial_print;
</span><span>
</span><span>#[no_mangle]
</span><span style="color:#569cd6;">pub extern </span><span style="color:#d69d85;">&quot;C&quot; </span><span style="color:#569cd6;">fn </span><span>_start() -&gt; </span><span style="color:#569cd6;">! </span><span>{
</span><span>    serial_print!(</span><span style="color:#d69d85;">&quot;stack_overflow::stack_overflow...</span><span style="color:#e3bbab;">\t</span><span style="color:#d69d85;">&quot;</span><span>);
</span><span>
</span><span>    blog_os::gdt::init();
</span><span>    init_test_idt();
</span><span>
</span><span>    </span><span style="color:#608b4e;">// trigger a stack overflow
</span><span>    stack_overflow();
</span><span>
</span><span>    panic!(</span><span style="color:#d69d85;">&quot;Execution continued after stack overflow&quot;</span><span>);
</span><span>}
</span><span>
</span><span>#[allow(unconditional_recursion)]
</span><span style="color:#569cd6;">fn </span><span>stack_overflow() {
</span><span>    stack_overflow(); </span><span style="color:#608b4e;">// for each recursion, the return address is pushed
</span><span>    volatile::Volatile::new(</span><span style="color:#b5cea8;">0</span><span>).read(); </span><span style="color:#608b4e;">// prevent tail recursion optimizations
</span><span>}
</span></code></pre>
<p>ุจุฑุง ุฑุงูโุงูุฏุงุฒ ฺฉ GDT ุฌุฏุฏุ ุชุงุจุน <code>gdt::init</code> ุฑุง ูุฑุงุฎูุงู ูโฺฉูู. ุจู ุฌุง ูุฑุงุฎูุงู ุชุงุจุน <code>interrupts::init_idt</code>ุ ุชุงุจุน <code>init_test_idt</code> ุฑุง ูุฑุงุฎูุงู ูโฺฉูู ฺฉู ุจุฒูุฏ ุชูุถุญ ุฏุงุฏู ูโุดูุฏ. ุฒุฑุง ูุง ูโุฎูุงูู ฺฉ ูุฏุฑ ุฎุทุง ุฏูฺฏุงูู ุณูุงุฑุด ุซุจุช ฺฉูู ฺฉู ุจู ุฌุง ูพูฺฉ ฺฉุฑุฏูุ ุฏุณุชูุฑ <code>exit_qemu(QemuExitCode::Success)</code> ุฑุง ุงูุฌุงู ูโุฏูุฏ.</p>
<p>ุชุงุจุน <code>stack_overflow</code> ุชูุฑุจุงู ูุดุงุจู ุชุงุจุน ููุฌูุฏ ุฏุฑ <code>main.rs</code> ุงุณุช. ุชููุง ุชูุงูุช ุงู ุงุณุช ฺฉู ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุจูููโุณุงุฒ ฺฉุงููพุงูุฑ ููุณูู ุจู <a href="https://en.wikipedia.org/wiki/Tail_call"><em>tail call elimination</em></a>ุ ุฏุฑ ูพุงุงู ุชุงุจุนุ ฺฉ ุฎูุงูุฏูู [ูุฑุงุฑู] (ุชุฑุฌูู: volatile) ุงุถุงูู ุจู ูุณูู ููุน <a href="https://docs.rs/volatile/0.2.6/volatile/struct.Volatile.html"><code>Volatile</code></a> ุงูุฌุงู ูโุฏูู. ุงุฒ ุฌูููุ ุงู ุจูููโุณุงุฒ ุจู ฺฉุงููพุงูุฑ ุงุฌุงุฒู ูโุฏูุฏ ุชุงุจุน ุฑุง ฺฉู ุขุฎุฑู ุนุจุงุฑุช ุขู ูุฑุงุฎูุงู ุชุงุจุน ุจุงุฒฺฏุดุช ุงุณุชุ ุจู ฺฉ ุญููู ุทุจุน ุชุจุฏู ฺฉูุฏ. ุจูุงุจุฑุงูุ ูฺ ูุงุจ ูพุดุชู ุงุถุงู ุจุฑุง ูุฑุงุฎูุงู ุชุงุจุน ุงุฌุงุฏ ููโุดูุฏุ ูพุณ ุงุณุชูุงุฏู ุงุฒ ูพุดุชู ุซุงุจุช ูโูุงูุฏ.</p>
<p>ุจุง ุงู ุญุงูุ ุฏุฑ ููุฑุฏ ูุงุ ูุง ูโุฎูุงูู ฺฉู ุณุฑุฑุฒ ูพุดุชู ุงุชูุงู ุจูุชุฏุ ุจูุงุจุฑุงู ุฏุฑ ุงูุชูุง ุชุงุจุน ฺฉ ุฏุณุชูุฑ ุฎูุงูุฏู ูุฑุงุฑ ุณุงุฎุชฺฏ ุงุถุงูู ูโฺฉููุ ฺฉู ฺฉุงููพุงูุฑ ูุฌุงุฒ ุจู ุญุฐู ุขู ูุณุช. ุจูุงุจุฑุงูุ ุชุงุจุน ุฏฺฏุฑ <em>tail recursive</em> ูุณุช ู ุงุฒ ุชุจุฏู ุจู ฺฉ ุญููู ุฌููฺฏุฑ ูโุดูุฏ. ูุง ููฺูู ุตูุช <code>allow(unconditional_recursion)</code> ุฑุง ุงุถุงูู ูโฺฉูู ุชุง ุงุฎุทุงุฑ ฺฉุงููพุงูุฑ ุฑุง ุฏุฑ ููุฑุฏ ุชฺฉุฑุงุฑ ุจโูููู ุชุงุจุน ุฎุงููุด ูฺฏู ุฏุงุฑุฏ.</p>
<h3 id="tst-idt"><a class="zola-anchor" href="index.html#tst-idt" aria-label="Anchor link for: tst-idt">๐</a>ุชุณุช IDT</h3>
<p>ููุงูุทูุฑ ฺฉู ุฏุฑ ุจุงูุง ุฐฺฉุฑ ุดุฏุ ุงู ุชุณุช ุจู IDT ูุฎุตูุต ุฎูุฏ ุจุง ฺฉ ูุฏุฑ ุฎุทุง ุฏูฺฏุงูู ุณูุงุฑุด ูุงุฒ ุฏุงุฑุฏ. ูพุงุฏูโุณุงุฒ ุจู ุงู ุดฺฉู ุงุณุช:</p>
<pre data-lang="rust" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#608b4e;">// in tests/stack_overflow.rs
</span><span>
</span><span style="color:#569cd6;">use </span><span>lazy_static::lazy_static;
</span><span style="color:#569cd6;">use </span><span>x86_64::structures::idt::InterruptDescriptorTable;
</span><span>
</span><span>lazy_static! {
</span><span>    </span><span style="color:#569cd6;">static ref </span><span style="color:#b4cea8;">TEST_IDT</span><span>: InterruptDescriptorTable = {
</span><span>        </span><span style="color:#569cd6;">let mut</span><span> idt = InterruptDescriptorTable::new();
</span><span>        </span><span style="color:#569cd6;">unsafe </span><span>{
</span><span>            idt.double_fault
</span><span>                .set_handler_fn(test_double_fault_handler)
</span><span>                .set_stack_index(blog_os::gdt::</span><span style="color:#b4cea8;">DOUBLE_FAULT_IST_INDEX</span><span>);
</span><span>        }
</span><span>
</span><span>        idt
</span><span>    };
</span><span>}
</span><span>
</span><span style="color:#569cd6;">pub fn </span><span>init_test_idt() {
</span><span>    </span><span style="color:#b4cea8;">TEST_IDT</span><span>.load();
</span><span>}
</span></code></pre>
<p>ูพุงุฏูโุณุงุฒ ุจุณุงุฑ ุดุจู IDT ุทุจุน ูุง ุฏุฑ <code>interrupts.rs</code> ุงุณุช. ูุงููุฏ IDT ุนุงุฏุ ุจุฑุง ูุฏุฑ ุฎุทุง ุฏูฺฏุงูู ุจู ููุธูุฑ ุฌุงุจุฌุง ุจู ูพุดุชูโุง ุฌุฏุงฺฏุงููุ ฺฉ ุงูุฏุณ ูพุดุชู ุฑุง ุฏุฑ IST ุชูุธู ูโฺฉูู. ุชุงุจุน <code>init_test_idt</code> ุจุง ุงุณุชูุงุฏู ุงุฒ ุฑูุด <code>load</code>ุ ุขโุฏโุช ุฑุง ุจุฑ ุฑู ูพุฑุฏุงุฒูุฏู ุจุงุฑฺฏุฐุงุฑ ูโฺฉูุฏ.</p>
<h3 id="mdyr-khty-dwgnh"><a class="zola-anchor" href="index.html#mdyr-khty-dwgnh" aria-label="Anchor link for: mdyr-khty-dwgnh">๐</a>ูุฏุฑ ุฎุทุง ุฏูฺฏุงูู</h3>
<p>ุชููุง ูุณูุช ุฌุงูุงูุฏูุ ูุฏุฑ ุฎุทุง ุฏูฺฏุงูู ุงุณุช ฺฉู ุจู ุงู ุดฺฉู ูพุงุฏูโุณุงุฒ ูโุดูุฏ:</p>
<pre data-lang="rust" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#608b4e;">// in tests/stack_overflow.rs
</span><span>
</span><span style="color:#569cd6;">use </span><span>blog_os::{exit_qemu, QemuExitCode, serial_println};
</span><span style="color:#569cd6;">use </span><span>x86_64::structures::idt::InterruptStackFrame;
</span><span>
</span><span style="color:#569cd6;">extern </span><span style="color:#d69d85;">&quot;x86-interrupt&quot; </span><span style="color:#569cd6;">fn </span><span>test_double_fault_handler(
</span><span>    _stack_frame: InterruptStackFrame,
</span><span>    _error_code: </span><span style="color:#569cd6;">u64</span><span>,
</span><span>) -&gt; </span><span style="color:#569cd6;">! </span><span>{
</span><span>    serial_println!(</span><span style="color:#d69d85;">&quot;[ok]&quot;</span><span>);
</span><span>    exit_qemu(QemuExitCode::Success);
</span><span>    </span><span style="color:#569cd6;">loop </span><span>{}
</span><span>}
</span></code></pre>
<p>ููฺฏุงู ฺฉู ูุฏุฑ ุฎุทุง ุฏูฺฏุงูู ูุฑุงุฎูุงู ูโุดูุฏุ ุงุฒ QEMU ุจุง ฺฉ ฺฉุฏ ุฎุฑูุฌ ููููุชโุขูุฒ ุฎุงุฑุฌ ูโุดููุ ฺฉู ุชุณุช ุฑุง ุจุนููุงู ยซูุจูู ุดุฏูยป ุนูุงูุชโฺฏุฐุงุฑ ูโุฏุงูุฏ. ุงุฒ ุขูโุฌุง ฺฉู ุชุณุชโูุง ฺฉูพุงุฑฺู ุงุฌุฑุงโูุง ฺฉุงููุงู ูุฌุฒุง ูุณุชูุฏุ ุจุงุฏ ุตูุช <code>[feature(abi_x86_interrupt)]!#</code> ุฑุง ุฏุฑ ุจุงูุง ูุงู ุชุณุช ุชูุธู ฺฉูู.</p>
<p>ุงฺฉููู ูโุชูุงูู ุชุณุช ุฑุง ุงุฒ ุทุฑู <code>cargo test --test stack_overflow</code> (ุง <code>cargo test</code> ุจุฑุง ุงุฌุฑุง ููู ุชุณุชโูุง) ุงูุฌุงู ุฏูู. ููุงูุทูุฑ ฺฉู ุงูุชุธุงุฑ ูโุฑูุชุ ุฎุฑูุฌ <code>stack_overflow... [ok ]</code> ุฑุง ุฏุฑ ฺฉูุณูู ูุดุงูุฏู ูโฺฉูู. ุฎุท <code>set_stack_index</code> ุฑุง ฺฉุงููุช ฺฉูุฏ: ุงู ุงูุฑ ุจุงุนุซ ูโุดูุฏ ุชุณุช ุงุฒ ฺฉุงุฑ ุจูุชุฏ.</p>
<h2 id="khlsh"><a class="zola-anchor" href="index.html#khlsh" aria-label="Anchor link for: khlsh">๐</a>ุฎูุงุตู</h2>
<p>ุฏุฑ ุงู ูพุณุช ุงุฏ ฺฏุฑูุชู ฺฉู ุฎุทุง ุฏูฺฏุงูู ฺุณุช ู ุฏุฑ ฺู ุดุฑุงุท ุฑุฎ ูโุฏูุฏ. ูุง ฺฉ ูุฏุฑ ุฎุทุง ุฏูฺฏุงูู ูพุงู ุงุถุงูู ฺฉุฑุฏู ฺฉู ูพุงู ุฎุทุง ุฑุง ฺุงูพ ูโฺฉูุฏ ู ฺฉ ุชุณุช ฺฉูพุงุฑฺู ุจุฑุง ุขู ุงุถุงูู ฺฉุฑุฏู.</p>
<p>ูุง ููฺูู ุชุนูุถ ูพุดุชู ูพุดุชุจุงู ุดุฏู ุณุฎุชโุงูุฒุงุฑ ุฑุง ุฏุฑ ุงุณุชุซูุงูุง ุฎุทุง ุฏูฺฏุงูู ูุนุงู ฺฉุฑุฏู ุชุง ุฏุฑ ุณุฑุฑุฒ ูพุดุชู ูุฒ ฺฉุงุฑ ฺฉูุฏ. ุฏุฑ ุญู ูพุงุฏูโุณุงุฒ ุขูุ ูุง ุจุง ุณฺฏููุช ูุถุนุช ูพุฑูุณู (TSS)ุ ุฌุฏูู ูพุดุชู ูููู (IST) ู ุฌุฏูู ุชูุตู ฺฉููุฏู ุณุฑุงุณุฑ (GDT) ุขุดูุง ุดุฏูุ ฺฉู ุจุฑุง ุณฺฏููุชโุจูุฏ ุฏุฑ ูุนูุงุฑโูุง ูุฏู ุงุณุชูุงุฏู ูโุดุฏ.</p>
<h2 id="b-dy-chyst"><a class="zola-anchor" href="index.html#b-dy-chyst" aria-label="Anchor link for: b-dy-chyst">๐</a>ุจุนุฏ ฺุณุชุ</h2>
<p>ูพุณุช ุจุนุฏ ูุญูู ูุฏุฑุช ููููโูุง ุฏุณุชฺฏุงูโูุง ุฎุงุฑุฌ ูุงููุฏ ุชุงูุฑุ ุตูุญู ฺฉูุฏ ุง ฺฉูุชุฑู ฺฉููุฏูโูุง ุดุจฺฉู ุฑุง ุชูุถุญ ูโุฏูุฏ. ุงู ููููโูุง ุณุฎุชโุงูุฒุงุฑ ุจุณุงุฑ ุดุจู ุจู ุงุณุชุซูุงูุง ูุณุชูุฏุ ุจู ุนููุงู ูุซุงู ุขูโูุง ูู ุงุฒ ุทุฑู IDT ุงุฑุณุงู ูโุดููุฏ. ุจุง ุงู ุญุงูุ ุจุฑุฎูุงู ุงุณุชุซูุงูุงุ ูุณุชููุงู ุฑู ูพุฑุฏุงุฒูุฏู ุฑุฎ ููโุฏููุฏ. ุฏุฑ ุนูุถุ ฺฉ <em>interrupt controller</em> ุงู ููููโูุง ุฑุง ุฌูุน ฺฉุฑุฏู ู ุจุณุชู ุจู ุงูููุชุ ุขูโูุง ุฑุง ุจู CPU ูโูุฑุณุชุฏ. ุฏุฑ ุจุฎุด ุจุนุฏุ ูุฏุฑ ูููู <a href="https://en.wikipedia.org/wiki/Intel_8259">Intel 8259</a> (โPICโ) ุฑุง ุจุฑุฑุณ ุฎูุงูู ฺฉุฑุฏ ู ูุญูู ูพุงุฏูโุณุงุฒ ูพุดุชุจุงู ุตูุญู ฺฉูุฏ ุฑุง ุงุฏ ุฎูุงูู ฺฏุฑูุช.</p>

    </div>

    <div class="post-footer-support right-to-left">
        <h2>Support Me</h2>
        
<p>
    Creating and <a href="../../status-update/index.html">maintaining</a> this blog and the associated libraries is a lot of work, but I really enjoy doing it. By supporting me, you allow me to invest more time in new content, new features, and continuous maintenance.
</p>
<p>
    The best way to support me is to <a href="https://github.com/sponsors/phil-opp"><em>sponsor me on GitHub</em></a>, since they don't charge any fees. If you prefer other platforms, I also have <a href="https://www.patreon.com/phil_opp"><em>Patreon</em></a> and <a href="https://donorbox.org/phil-opp"><em>Donorbox</em></a> accounts. The latter is the most flexible as it supports multiple currencies and one-time contributions.
</p>
<p>
    Thank you!
</p>

    </div>

    <hr>
    <div class="PageNavigation">
        
            <a class="prev" href="../cpu-exceptions/index.html">&laquo; ุงุณุชุซูุงูุง ูพุฑุฏุงุฒูุฏู</a>
        
        
            <a class="next" href="../hardware-interrupts/index.html">ููููโูุง ุณุฎุชโุงูุฒุงุฑ &raquo;</a>
        
    </div>

    <hr>
    <section>
        <h2 id="comments" class="right-to-left">ูุธุฑุงุช</h2>

        
            
            
            
        
        
    
        
        
    

    
        
        
    

    <p class="comment-note">
        Do you have a problem, want to share feedback, or discuss further ideas? Feel free to leave a comment here! Please stick to English and follow Rust's <a href="https://www.rust-lang.org/policies/code-of-conduct">code of conduct</a>. This comment thread directly maps to a <a href="https://github.com/phil-opp/blog_os/discussions/categories/post-comments-translated?discussions_q=%22Double%20Faults%20%28fa%29%22"><em>discussion on GitHub</em></a>, so you can also comment there if you prefer.
    </p>

    <div class="giscus"></div>

    <script src="https://giscus.app/client.js"
        data-repo="phil-opp/blog_os"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzOTU3NTEwMQ=="
        data-category="Post Comments (translated)"
        data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMzMDE4OTg1"
    
        data-mapping="specific"
    
        data-term="Double Faults (fa)"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-theme="preferred_color_scheme"
        data-lang="fa"
        crossorigin="anonymous"
        async>
    </script>

    <p class="comment-directly-on-github">
        Instead of authenticating the <a href="https://giscus.app">giscus</a> application, you can also comment directly <a href="https://github.com/phil-opp/blog_os/discussions/categories/post-comments-translated?discussions_q=%22Double%20Faults%20%28fa%29%22"><em>on GitHub</em></a>.
    </p>

        <p class="right-to-left">
            ูุทูุง ูุธุฑุงุช ุฎูุฏ ุฑุง ุฏุฑ ุตูุฑุช ุงูฺฉุงู ุจู ุงูฺฏูุณ ุจููุณุฏ.
        </p>
        
    </section>

    <aside class="page-aside-right">
        <div class="block" id="language-selector">
            <h2>Other Languages</h2>
            
            <ul><li data-lang-switch-to="en" class=""><a href="../../double-fault-exceptions/index.html">
                        English (original)
                    </a></li><li data-lang-switch-to="zh-CN" class=""><a href="../../zh-CN/double-fault-exceptions/index.html">
                        Chinese (simplified)
                    </a></li><li data-lang-switch-to="ja" class=""><a href="../../ja/double-fault-exceptions/index.html">
                        Japanese
                    </a></li><li data-lang-switch-to="ko" class=""><a href="../../ko/double-fault-exceptions/index.html">
                        Korean
                    </a></li></ul>
        </div>
    </aside>

</main>
        </div>

        <div></div>

        <footer class="footer">
            <hr>
            <small>
                &copy; <time datetime="2022">2022</time>. All rights reserved.
                <a class="spaced" href="https://github.com/phil-opp/blog_os#license">License</a>
                <a class="spaced" href="../../contact/index.html">Contact</a>
            </small>
        </footer>
    </div>
</body>

</html>
